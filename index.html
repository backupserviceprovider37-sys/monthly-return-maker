<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Return Maker - Complete SPA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Noto Sans Bengali', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .bengali-text {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        
        /* === UTILITY CLASSES === */
        .hidden {
            display: none !important;
        }
        
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* === LOADING OVERLAY === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a5f7a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* === MESSAGE SYSTEM === */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .message.success { background-color: #4caf50; }
        .message.error { background-color: #f44336; }
        .message.info { background-color: #2196f3; }
        
        /* === APP LAYOUT === */
        #appContainer {
            display: flex;
            min-height: 100vh;
        }
        
        /* === SIDEBAR === */
        #sidebar {
            width: 260px;
            background-color: #1a5f7a;
            color: white;
            padding: 20px 0;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .logo-container {
            text-align: center;
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .logo-sub {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .user-info {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-avatar {
            width: 70px;
            height: 70px;
            background-color: #2d8da1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
        }
        
        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .user-email {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .nav-menu {
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-item.active {
            background-color: rgba(255,255,255,0.15);
            color: white;
            border-left: 4px solid #ffcc00;
        }
        
        .nav-item i {
            margin-right: 15px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .logout-btn {
            margin-top: 30px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            transition: all 0.3s;
            border-top: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .logout-btn:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* === MAIN CONTENT === */
        #mainContent {
            flex: 1;
            margin-left: 0;
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s;
        }
        
        /* === LOGIN VIEW === */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .main-title {
            font-size: 2.8rem;
            color: #1a5f7a;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .sub-title {
            font-size: 1.1rem;
            color: #2d8da1;
            font-weight: 500;
        }
        
        .login-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 450px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #1a5f7a;
            border-bottom: 3px solid #1a5f7a;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* === FORM STYLES === */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 1rem;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1a5f7a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26,95,122,0.1);
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
        }
        
        .btn {
            padding: 14px 20px;
            background-color: #1a5f7a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover:not(:disabled) {
            background-color: #14495c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26,95,122,0.3);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-success:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        
        /* === DASHBOARD VIEW === */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 25px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 25px;
        }
        
        .page-title {
            font-size: 1.8rem;
            color: #333;
            font-weight: 600;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
        }
        
        .progress-text {
            margin-right: 15px;
            font-weight: 500;
            color: #444;
        }
        
        .progress-bar {
            width: 200px;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #1a5f7a;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .progress-percent {
            margin-left: 10px;
            font-weight: 600;
            color: #1a5f7a;
        }
        
        .welcome-section {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .welcome-title {
            font-size: 1.8rem;
            color: #1a5f7a;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .tasks-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .task-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .task-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
            color: white;
        }
        
        .icon-profile { background-color: #ff9800; }
        .icon-teachers { background-color: #2196f3; }
        .icon-students { background-color: #4caf50; }
        
        .task-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }
        
        .task-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .status-complete { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        
        .task-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        /* === FORM CONTAINERS === */
        .form-container {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .form-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-title {
            font-size: 1.8rem;
            color: #1a5f7a;
            margin-bottom: 10px;
        }
        
        .form-subtitle {
            color: #666;
            font-size: 1rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 1rem;
        }
        
        .form-label.required:after {
            content: " *";
            color: #e53935;
        }
        
        .form-hint {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85rem;
        }
        
        .form-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }
        
        /* === TABLE STYLES === */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            #sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: #1a5f7a;
                color: white;
                border: none;
                padding: 12px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1.2rem;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .progress-container {
                margin-top: 15px;
                width: 100%;
            }
            
            .progress-bar {
                width: 100%;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .tasks-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .logo {
                font-size: 1.5rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .login-card {
                padding: 25px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .user-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading...</div>
    </div>
    
    <!-- Message Container -->
    <div class="message" id="messageContainer"></div>
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn hidden" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- App Container -->
    <div id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-container">
                <div class="logo">Monthly Return Maker</div>
                <div class="logo-sub bengali-text">প্রাথমিক বিদ্যালয় ব্যবহারের জন্য</div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-name" id="displayUserName">User Name</div>
                <div class="user-email" id="displayUserEmail">user@example.com</div>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item active" data-view="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-view="schoolProfile">
                    <i class="fas fa-school"></i>
                    <span>School Profile</span>
                </div>
                <div class="nav-item" data-view="teachers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Teachers</span>
                </div>
                <div class="nav-item" data-view="students">
                    <i class="fas fa-users"></i>
                    <span>Students</span>
                </div>
                <div class="nav-item" data-view="pdfPreview">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF Preview</span>
                </div>
            </div>
            
            <div class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent">
            <!-- Login View -->
            <div class="view active" id="loginView">
                <div class="login-container">
                    <div class="login-header">
                        <h1 class="main-title">Monthly Return Maker</h1>
                        <p class="sub-title bengali-text">প্রাথমিক বিদ্যালয় ব্যবহারের জন্য</p>
                    </div>
                    
                    <div class="login-card">
                        <div class="tabs">
                            <div class="tab active" data-tab="login">Login</div>
                            <div class="tab" data-tab="register">Register</div>
                        </div>
                        
                        <!-- Messages -->
                        <div id="message" class="message"></div>
                        
                        <!-- Login Form -->
                        <div id="login-form" class="tab-content active">
                            <form id="loginForm">
                                <div class="form-group">
                                    <label for="loginUser"><i class="fas fa-user"></i> Username</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-user"></i>
                                        <input type="text" id="loginUser" placeholder="Enter your username" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                                        <span class="password-toggle" id="loginPasswordToggle">
                                            <i class="fas fa-eye"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn">Login</button>
                            </form>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <a href="#" id="forgotPasswordLink" style="color: #1a5f7a; text-decoration: none; font-weight: 600;">
                                    Forgot Username or Password?
                                </a>
                            </div>
                        </div>
                        
                        <!-- Registration Form -->
                        <div id="register-form" class="tab-content">
                            <form id="registerForm">
                                <div class="form-group">
                                    <label for="regUser"><i class="fas fa-user"></i> Username *</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-user"></i>
                                        <input type="text" id="regUser" placeholder="Choose a username" required>
                                    </div>
                                    <small class="form-hint">(Minimum 3 characters)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="regPassword"><i class="fas fa-lock"></i> Password *</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" id="regPassword" placeholder="Choose a password" required>
                                        <span class="password-toggle" id="regPasswordToggle">
                                            <i class="fas fa-eye"></i>
                                        </span>
                                    </div>
                                    <small class="form-hint">(5 to 10 characters)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="regMobile"><i class="fas fa-mobile-alt"></i> Mobile Number *</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                        <input type="tel" id="regMobile" placeholder="10-digit mobile number" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="regEmail"><i class="fas fa-envelope"></i> Email *</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-envelope"></i>
                                        <input type="email" id="regEmail" placeholder="Email address" required>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn">Create Account</button>
                            </form>
                        </div>
                        
                        <!-- Forgot Password Form -->
                        <div id="forgot-form" class="tab-content">
                            <div class="form-group">
                                <p style="margin-bottom: 20px; text-align: center;">Enter your mobile number and email. We will send your username and password to your email.</p>
                            </div>
                            
                            <form id="forgotForm">
                                <div class="form-group">
                                    <label for="forgotMobile"><i class="fas fa-mobile-alt"></i> Mobile Number *</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                        <input type="tel" id="forgotMobile" placeholder="10-digit mobile number" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="forgotEmail"><i class="fas fa-envelope"></i> Email *</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-envelope"></i>
                                        <input type="email" id="forgotEmail" placeholder="Your email address" required>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn">Send</button>
                                <button type="button" id="backToLogin" class="btn btn-secondary" style="margin-top: 10px;">Back to Login</button>
                            </form>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 0.9rem;">
                        <p>© 2026 Monthly Return Maker | <span class="bengali-text">তৈরি করেছেন: সুমিত</span></p>
                        <p class="bengali-text">সমস্ত ডেটা সুরক্ষিতভাবে সংরক্ষিত রাখা হয়</p>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard View -->
            <div class="view" id="dashboardView">
                <div class="top-bar">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="progress-container">
                        <span class="progress-text">Completion Progress:</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <span class="progress-percent" id="progressPercent">0%</span>
                    </div>
                </div>
                
                <div class="welcome-section">
                    <h2 class="welcome-title">Welcome to Monthly Return Maker</h2>
                    <p class="welcome-message">Complete the following 3 tasks to generate your monthly return. Your progress is tracked below.</p>
                    <p class="bengali-text" id="welcomeBengali">স্বাগতম!</p>
                </div>
                
                <div class="tasks-section">
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-icon icon-profile">
                                <i class="fas fa-school"></i>
                            </div>
                            <div>
                                <h3 class="task-title">Task 1: School Profile</h3>
                                <span class="task-status status-pending" id="profileStatus">PENDING</span>
                            </div>
                        </div>
                        <p class="task-description">Fill in your school details including name, address, DISE code, and contact information.</p>
                        <button class="btn" id="profileBtn" style="margin-top: 10px;">Complete Profile</button>
                    </div>
                    
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-icon icon-teachers">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div>
                                <h3 class="task-title">Task 2: Teacher Details</h3>
                                <span class="task-status status-pending" id="teacherStatus">PENDING</span>
                            </div>
                        </div>
                        <p class="task-description">Add at least one teacher with their designation, qualifications, date of birth, and joining dates.</p>
                        <button class="btn" id="teacherBtn" disabled style="margin-top: 10px;">Add Teachers</button>
                    </div>
                    
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-icon icon-students">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h3 class="task-title">Task 3: Student Details</h3>
                                <span class="task-status status-pending" id="studentStatus">PENDING</span>
                            </div>
                        </div>
                        <p class="task-description">Select classes and enter student counts for Pre-Primary to Class V.</p>
                        <button class="btn" id="studentBtn" disabled style="margin-top: 10px;">Enter Student Data</button>
                    </div>
                </div>
                
                <div class="form-container">
                    <h2 style="font-size: 1.5rem; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">Your Account Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <div style="padding: 12px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #1a5f7a;" id="detailUsername">-</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <div style="padding: 12px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #1a5f7a;" id="detailMobile">-</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <div style="padding: 12px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #1a5f7a;" id="detailEmail">-</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Created</label>
                            <div style="padding: 12px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #1a5f7a;" id="detailCreated">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- School Profile View -->
            <div class="view" id="schoolProfileView">
                <div class="top-bar">
                    <h1 class="page-title">School Profile</h1>
                    <div class="progress-container">
                        <span class="progress-text">Task 1 of 3</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 33%; background-color: #ff9800;"></div>
                        </div>
                        <span class="progress-percent" style="color: #ff9800;">33%</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="backToDashboard" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                
                <div class="form-container">
                    <div class="form-header">
                        <h2 class="form-title">School Information</h2>
                        <p class="form-subtitle">This information will fill the yellow section of the monthly return PDF</p>
                    </div>
                    
                    <form id="schoolProfileForm">
                        <div class="form-grid">
                            <div>
                                <div class="form-group">
                                    <label for="schoolName" class="form-label required">School Name</label>
                                    <input type="text" id="schoolName" placeholder="Enter full school name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="circle" class="form-label required">Circle</label>
                                    <input type="text" id="circle" placeholder="Enter circle name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="villageWard" class="form-label required">Village / Ward</label>
                                    <input type="text" id="villageWard" placeholder="Enter village or ward name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="policeStation" class="form-label required">Police Station</label>
                                    <input type="text" id="policeStation" placeholder="Enter police station name" required>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label for="postOffice" class="form-label required">Post Office</label>
                                    <input type="text" id="postOffice" placeholder="Enter post office name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="gramPanchayat" class="form-label required">Gram Panchayat / Municipality</label>
                                    <input type="text" id="gramPanchayat" placeholder="Enter gram panchayat or municipality" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="pinCode" class="form-label required">PIN Code</label>
                                    <input type="text" id="pinCode" placeholder="6-digit PIN code" pattern="[0-9]{6}" maxlength="6" required>
                                    <span class="form-hint">Must be 6 digits</span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="diseCode" class="form-label required">DISE Code</label>
                                    <input type="text" id="diseCode" placeholder="Enter DISE code" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="schoolNumber" class="form-label required">School Number</label>
                                    <input type="text" id="schoolNumber" placeholder="Enter school number" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelSchoolProfile">Cancel</button>
                            <button type="submit" class="btn" id="saveSchoolProfileBtn">Save School Profile</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Teachers View -->
            <div class="view" id="teachersView">
                <div class="top-bar">
                    <h1 class="page-title">Teacher Details</h1>
                    <div class="progress-container">
                        <span class="progress-text">Task 2 of 3</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 66%; background-color: #2196f3;"></div>
                        </div>
                        <span class="progress-percent" style="color: #2196f3;">66%</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="backToDashboard2" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                
                <div class="form-container">
                    <div class="form-header">
                        <h2 class="form-title">Add Teachers</h2>
                        <p class="form-subtitle">Add at least one teacher. You can add multiple teachers as needed.</p>
                    </div>
                    
                    <div class="table-container">
                        <table id="teachersTable">
                            <thead>
                                <tr>
                                    <th>SL No</th>
                                    <th>Teacher Name</th>
                                    <th>Designation</th>
                                    <th>Highest Qualification</th>
                                    <th>Date of Birth</th>
                                    <th>Date of Joining</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody">
                                <tr id="noTeachersRow">
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                        No teachers added yet. Click "Add New Teacher" below to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn" id="addTeacherBtn" style="margin: 20px 0;">
                        <i class="fas fa-plus"></i> Add New Teacher
                    </button>
                    
                    <div id="teacherFormContainer" class="hidden" style="background-color: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 20px;">
                        <h3 style="margin-bottom: 20px; color: #333;">New Teacher Information</h3>
                        <form id="teacherForm">
                            <div class="form-grid">
                                <div>
                                    <div class="form-group">
                                        <label for="teacherName" class="form-label required">Teacher Name</label>
                                        <input type="text" id="teacherName" placeholder="Enter full name" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="designation" class="form-label required">Designation</label>
                                        <select id="designation" required>
                                            <option value="">Select Designation</option>
                                            <option value="Head Teacher">Head Teacher</option>
                                            <option value="Assistant Teacher">Assistant Teacher</option>
                                            <option value="SMC Teacher">SMC Teacher</option>
                                            <option value="Guest Teacher">Guest Teacher</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="qualification" class="form-label required">Highest Qualification</label>
                                        <select id="qualification" required>
                                            <option value="">Select Qualification</option>
                                            <option value="Below Secondary">Below Secondary</option>
                                            <option value="Secondary">Secondary</option>
                                            <option value="Higher Secondary">Higher Secondary</option>
                                            <option value="Graduate">Graduate</option>
                                            <option value="Post Graduate">Post Graduate</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="form-group">
                                        <label for="dob" class="form-label required">Date of Birth</label>
                                        <input type="date" id="dob" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="doj" class="form-label required">Date of Joining</label>
                                        <input type="date" id="doj" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="remarks" class="form-label">Remarks (Optional)</label>
                                        <input type="text" id="remarks" placeholder="Any additional information">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-top: 25px;">
                                <button type="submit" class="btn">Save Teacher</button>
                                <button type="button" class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn" id="saveTeachersBtn">
                            <i class="fas fa-check"></i> Save All Teachers
                        </button>
                    </div>
                </div>
            </div>

            <!-- Students View -->
            <div class="view" id="studentsView">
                <div class="top-bar">
                    <h1 class="page-title">Student Details</h1>
                    <div class="progress-container">
                        <span class="progress-text">Task 3 of 3</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%; background-color: #4caf50;"></div>
                        </div>
                        <span class="progress-percent" style="color: #4caf50;">100%</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="backToDashboard3" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                
                <div class="form-container">
                    <div class="form-header">
                        <h2 class="form-title">Enter Student Counts</h2>
                        <p class="form-subtitle">Enter the number of students in each class from Pre-Primary to Class V</p>
                    </div>
                    
                    <form id="studentsForm">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; margin: 20px 0;">
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>Boys</th>
                                        <th>Girls</th>
                                        <th>Total Students</th>
                                        <th>Remarks (Optional)</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin: 30px 0;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 5px;">Grand Totals</h4>
                                <p style="color: #666; font-size: 0.9rem;">All classes combined</p>
                            </div>
                            <div style="display: flex; gap: 30px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: 700; color: #1a5f7a;" id="totalBoys">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Total Boys</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: 700; color: #1a5f7a;" id="totalGirls">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Total Girls</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: 700; color: #1a5f7a;" id="totalStudents">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Total Students</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Student Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- PDF Preview View -->
            <div class="view" id="pdfPreviewView">
                <div class="top-bar">
                    <h1 class="page-title">PDF Preview</h1>
                    <button class="btn" id="refreshPreviewBtn" style="margin-left: auto;">
                        <i class="fas fa-redo"></i> Refresh Preview
                    </button>
                </div>
                
                <button class="btn btn-secondary" id="backToDashboard4" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                
                <div class="form-container">
                    <div class="form-header">
                        <h2 class="form-title">Monthly Return PDF</h2>
                        <p class="form-subtitle">Preview and download your completed monthly return</p>
                    </div>
                    
                    <div id="previewStatus" style="padding: 20px; background-color: #fff3cd; border-radius: 8px; margin-bottom: 30px;">
                        <h4 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Preview Not Available</h4>
                        <p style="color: #856404; margin-bottom: 5px;">Complete all 3 tasks to generate the PDF:</p>
                        <ul style="color: #856404; padding-left: 20px; margin: 0;">
                            <li id="previewTask1">❌ School Profile</li>
                            <li id="previewTask2">❌ Teacher Details</li>
                            <li id="previewTask3">❌ Student Data</li>
                        </ul>
                    </div>
                    
                    <div id="previewContainer" class="hidden" style="border: 2px solid #ddd; border-radius: 8px; padding: 20px; background-color: white;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <button class="btn btn-success" id="generatePdfBtn" style="margin-right: 10px;">
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                            <button class="btn" id="downloadPdfBtn">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                        
                        <div style="border: 1px solid #ccc; padding: 30px; background-color: white; min-height: 500px; font-family: 'Times New Roman', serif;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <h2 style="font-size: 24px; margin-bottom: 10px;">MONTHLY RETURN OF PRIMARY SCHOOL</h2>
                                <p style="font-size: 14px; color: #666;">(As per RTE Act 2009)</p>
                            </div>
                            
                            <div style="margin-bottom: 30px; background-color: #fffacd; padding: 15px; border: 1px solid #e6db55;">
                                <h3 style="font-size: 16px; margin-bottom: 10px; text-align: center;">SCHOOL INFORMATION</h3>
                                <table style="width: 100%; font-size: 14px;">
                                    <tr>
                                        <td style="width: 30%;"><strong>School Name:</strong></td>
                                        <td id="pdfSchoolName">[School Name]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Circle:</strong></td>
                                        <td id="pdfCircle">[Circle]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Village/Ward:</strong></td>
                                        <td id="pdfVillageWard">[Village/Ward]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>P.S.:</strong></td>
                                        <td id="pdfPoliceStation">[Police Station]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Post Office:</strong></td>
                                        <td id="pdfPostOffice">[Post Office]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Gram Panchayat/Municipality:</strong></td>
                                        <td id="pdfGramPanchayat">[Gram Panchayat]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>PIN:</strong></td>
                                        <td id="pdfPinCode">[PIN Code]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>DISE Code:</strong></td>
                                        <td id="pdfDiseCode">[DISE Code]</td>
                                    </tr>
                                    <tr>
                                        <td><strong>School No.:</strong></td>
                                        <td id="pdfSchoolNumber">[School Number]</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="font-size: 16px; margin-bottom: 10px; text-align: center;">TEACHER DETAILS</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th style="border: 1px solid #ccc; padding: 8px;">SL No</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Teacher Name</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Designation</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Highest Qualification</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Date of Birth</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Date of Joining</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pdfTeachersTable">
                                        <tr>
                                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;" colspan="6">No teacher data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="font-size: 16px; margin-bottom: 10px; text-align: center;">STUDENT DETAILS - MONTH: <span id="pdfMonthYear">[Month Year]</span></h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th style="border: 1px solid #ccc; padding: 8px;">Class</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Boys</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Girls</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Total Students</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pdfStudentsTable">
                                        <tr>
                                            <td style="border: 1px solid #ccc; padding: 8px; text-align: center;" colspan="5">No student data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                                <div>
                                    <p>___________________</p>
                                    <p>Signature of Head Teacher</p>
                                </div>
                                <div>
                                    <p>___________________</p>
                                    <p>Signature of SMC President</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============== CONFIGURATION ===============
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJ0vDpC58Ajc9pcI9TAgOh2KoGgdGcJFCKv5K-se8i9d99_27q3YB4WTlKqhbtsXzo/exec';
        const APP_VERSION = '1.0.0';
        
        // =============== STATE MANAGEMENT ===============
        let currentUser = null;
        let userData = null;
        let schoolProfile = null;
        let teachers = [];
        let students = [];
        let appState = {
            profileComplete: false,
            teachersComplete: false,
            studentsComplete: false
        };
        
        // =============== DOM ELEMENTS ===============
        const elements = {
            // Layout elements
            appContainer: document.getElementById('appContainer'),
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('mainContent'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            
            // Views
            loginView: document.getElementById('loginView'),
            dashboardView: document.getElementById('dashboardView'),
            schoolProfileView: document.getElementById('schoolProfileView'),
            teachersView: document.getElementById('teachersView'),
            studentsView: document.getElementById('studentsView'),
            pdfPreviewView: document.getElementById('pdfPreviewView'),
            views: document.querySelectorAll('.view'),
            
            // User info
            displayUserName: document.getElementById('displayUserName'),
            displayUserEmail: document.getElementById('displayUserEmail'),
            
            // Login elements
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            forgotForm: document.getElementById('forgotForm'),
            loginUser: document.getElementById('loginUser'),
            loginPassword: document.getElementById('loginPassword'),
            regUser: document.getElementById('regUser'),
            regPassword: document.getElementById('regPassword'),
            regMobile: document.getElementById('regMobile'),
            regEmail: document.getElementById('regEmail'),
            forgotMobile: document.getElementById('forgotMobile'),
            forgotEmail: document.getElementById('forgotEmail'),
            loginPasswordToggle: document.getElementById('loginPasswordToggle'),
            regPasswordToggle: document.getElementById('regPasswordToggle'),
            forgotPasswordLink: document.getElementById('forgotPasswordLink'),
            backToLogin: document.getElementById('backToLogin'),
            
            // Dashboard elements
            progressFill: document.getElementById('progressFill'),
            progressPercent: document.getElementById('progressPercent'),
            profileStatus: document.getElementById('profileStatus'),
            teacherStatus: document.getElementById('teacherStatus'),
            studentStatus: document.getElementById('studentStatus'),
            profileBtn: document.getElementById('profileBtn'),
            teacherBtn: document.getElementById('teacherBtn'),
            studentBtn: document.getElementById('studentBtn'),
            detailUsername: document.getElementById('detailUsername'),
            detailMobile: document.getElementById('detailMobile'),
            detailEmail: document.getElementById('detailEmail'),
            detailCreated: document.getElementById('detailCreated'),
            
            // Navigation elements
            navItems: document.querySelectorAll('.nav-item'),
            logoutBtn: document.getElementById('logoutBtn'),
            
            // School profile elements
            schoolProfileForm: document.getElementById('schoolProfileForm'),
            backToDashboard: document.getElementById('backToDashboard'),
            cancelSchoolProfile: document.getElementById('cancelSchoolProfile'),
            saveSchoolProfileBtn: document.getElementById('saveSchoolProfileBtn'),
            
            // Teachers elements
            teachersTable: document.getElementById('teachersTable'),
            teachersTableBody: document.getElementById('teachersTableBody'),
            noTeachersRow: document.getElementById('noTeachersRow'),
            addTeacherBtn: document.getElementById('addTeacherBtn'),
            teacherFormContainer: document.getElementById('teacherFormContainer'),
            teacherForm: document.getElementById('teacherForm'),
            cancelTeacherBtn: document.getElementById('cancelTeacherBtn'),
            saveTeachersBtn: document.getElementById('saveTeachersBtn'),
            backToDashboard2: document.getElementById('backToDashboard2'),
            
            // Students elements
            studentsForm: document.getElementById('studentsForm'),
            studentsTableBody: document.getElementById('studentsTableBody'),
            totalBoys: document.getElementById('totalBoys'),
            totalGirls: document.getElementById('totalGirls'),
            totalStudents: document.getElementById('totalStudents'),
            backToDashboard3: document.getElementById('backToDashboard3'),
            
            // PDF Preview elements
            backToDashboard4: document.getElementById('backToDashboard4'),
            previewStatus: document.getElementById('previewStatus'),
            previewContainer: document.getElementById('previewContainer'),
            refreshPreviewBtn: document.getElementById('refreshPreviewBtn'),
            generatePdfBtn: document.getElementById('generatePdfBtn'),
            downloadPdfBtn: document.getElementById('downloadPdfBtn'),
            previewTask1: document.getElementById('previewTask1'),
            previewTask2: document.getElementById('previewTask2'),
            previewTask3: document.getElementById('previewTask3'),
            
            // Utility
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            messageContainer: document.getElementById('messageContainer')
        };
        
        // =============== UTILITY FUNCTIONS ===============
        function showLoading(message = 'Loading...') {
            elements.loadingText.textContent = message;
            elements.loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            elements.loadingOverlay.style.display = 'none';
        }
        
        function showMessage(text, type = 'info') {
            elements.messageContainer.textContent = text;
            elements.messageContainer.className = `message ${type}`;
            elements.messageContainer.style.display = 'block';
            
            setTimeout(() => {
                elements.messageContainer.style.display = 'none';
            }, 5000);
        }
        
        function validatePassword(password) {
            return password.length >= 5 && password.length <= 10;
        }
        
        function validateMobile(mobile) {
            return /^\d{10}$/.test(mobile);
        }
        
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function validatePIN(pin) {
            return /^\d{6}$/.test(pin);
        }
        
        // =============== VIEW MANAGEMENT ===============
        function showView(viewId) {
            // Hide all views
            elements.views.forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }
            
            // Update navigation
            elements.navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-view') === viewId.replace('View', '').toLowerCase()) {
                    item.classList.add('active');
                }
            });
            
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                elements.sidebar.classList.remove('active');
            }
        }
        
        function switchToLoggedInState() {
            elements.loginView.classList.remove('active');
            elements.sidebar.style.display = 'block';
            
            if (window.innerWidth > 768) {
                elements.mainContent.style.marginLeft = '260px';
            } else {
                elements.mobileMenuBtn.classList.remove('hidden');
            }
            
            showView('dashboardView');
            updateDashboard();
        }
        
        function switchToLoggedOutState() {
            // Clear user data
            currentUser = null;
            userData = null;
            schoolProfile = null;
            teachers = [];
            students = [];
            appState = {
                profileComplete: false,
                teachersComplete: false,
                studentsComplete: false
            };
            
            // Reset UI
            elements.sidebar.style.display = 'none';
            elements.mainContent.style.marginLeft = '0';
            elements.mobileMenuBtn.classList.add('hidden');
            showView('loginView');
            
            // Clear forms
            elements.loginForm.reset();
            elements.registerForm.reset();
            elements.forgotForm.reset();
        }
        
        // =============== API FUNCTION ===============
        async function callAPI(action, data = null) {
            showLoading('Processing...');
            
            try {
                let url = `${SCRIPT_URL}?action=${action}`;
                
                console.log('Calling API:', action, data);
                
                // If no data, simple GET request
                if (!data) {
                    const response = await fetch(url);
                    const result = await response.json();
                    hideLoading();
                    return result;
                }
                
                // Use FormData for POST
                const formData = new FormData();
                for (const key in data) {
                    formData.append(key, data[key]);
                }
                
                // Make POST request
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideLoading();
                return result;
                
            } catch (error) {
                hideLoading();
                console.error('API Error:', error);
                showMessage('Network error. Please check your internet connection.', 'error');
                return { success: false, message: 'Network error: ' + error.message };
            }
        }
        
        // =============== WORKAROUND FOR MISSING GAS ENDPOINTS ===============
        async function getUserDataWorkaround(username) {
            if (!username) return null;
            
            try {
                // We need to login first to get user ID
                // This will be called after successful login
                return null; // Will be populated after login
                
            } catch (error) {
                console.error('Workaround error:', error);
                return null;
            }
        }
        
        // =============== DATA MANAGEMENT ===============
        async function loadUserData(userId) {
            if (!userId) return;
            
            try {
                // Get user progress
                const progressResult = await callAPI('getProgress', { id: userId });
                
                // Get school profile
                const profileResult = await callAPI('getSchoolProfile', { id: userId });
                
                // Get teachers
                const teachersResult = await callAPI('getTeachers', { id: userId });
                
                // Get students
                const studentsResult = await callAPI('getStudentData', { id: userId });
                
                // Update state
                if (profileResult.success && profileResult.profile) {
                    schoolProfile = profileResult.profile;
                    appState.profileComplete = true;
                    loadSchoolProfileForm();
                }
                
                if (teachersResult.success && teachersResult.teachers && teachersResult.teachers.length > 0) {
                    teachers = teachersResult.teachers;
                    appState.teachersComplete = true;
                    renderTeachersTable();
                }
                
                if (studentsResult.success && studentsResult.studentData && studentsResult.studentData.length > 0) {
                    students = studentsResult.studentData;
                    appState.studentsComplete = true;
                    loadStudentsForm();
                }
                
                // Update user display with info from login
                if (userData) {
                    updateUserDisplay();
                }
                
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        function updateUserDisplay() {
            if (userData) {
                elements.displayUserName.textContent = userData.username || currentUser;
                elements.displayUserEmail.textContent = userData.email || '';
                
                elements.detailUsername.textContent = userData.username || currentUser;
                elements.detailMobile.textContent = userData.mobile || '';
                elements.detailEmail.textContent = userData.email || '';
                elements.detailCreated.textContent = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString() : 'Not available';
            }
        }
        
        // =============== DASHBOARD FUNCTIONS ===============
        function updateDashboard() {
            // Calculate progress
            let completedTasks = 0;
            if (appState.profileComplete) completedTasks++;
            if (appState.teachersComplete) completedTasks++;
            if (appState.studentsComplete) completedTasks++;
            
            const progressPercent = Math.round((completedTasks / 3) * 100);
            
            // Update progress bar
            elements.progressFill.style.width = `${progressPercent}%`;
            elements.progressPercent.textContent = `${progressPercent}%`;
            
            // Update task statuses
            elements.profileStatus.textContent = appState.profileComplete ? 'COMPLETE' : 'PENDING';
            elements.profileStatus.className = `task-status ${appState.profileComplete ? 'status-complete' : 'status-pending'}`;
            
            elements.teacherStatus.textContent = appState.teachersComplete ? 'COMPLETE' : 'PENDING';
            elements.teacherStatus.className = `task-status ${appState.teachersComplete ? 'status-complete' : 'status-pending'}`;
            
            elements.studentStatus.textContent = appState.studentsComplete ? 'COMPLETE' : 'PENDING';
            elements.studentStatus.className = `task-status ${appState.studentsComplete ? 'status-complete' : 'status-pending'}`;
            
            // Enable/disable buttons
            elements.profileBtn.disabled = false;
            elements.teacherBtn.disabled = !appState.profileComplete;
            elements.studentBtn.disabled = !(appState.profileComplete && appState.teachersComplete);
            
            // Update button texts
            elements.profileBtn.textContent = appState.profileComplete ? 'Edit Profile' : 'Complete Profile';
            elements.teacherBtn.textContent = appState.teachersComplete ? 'Edit Teachers' : 'Add Teachers';
            elements.studentBtn.textContent = appState.studentsComplete ? 'Edit Students' : 'Enter Student Data';
            
            // Update PDF preview status
            updatePdfPreviewStatus();
        }
        
        // =============== SCHOOL PROFILE FUNCTIONS ===============
        function loadSchoolProfileForm() {
            if (schoolProfile) {
                document.getElementById('schoolName').value = schoolProfile.schoolName || '';
                document.getElementById('circle').value = schoolProfile.circle || '';
                document.getElementById('villageWard').value = schoolProfile.villageWard || '';
                document.getElementById('policeStation').value = schoolProfile.policeStation || '';
                document.getElementById('postOffice').value = schoolProfile.postOffice || '';
                document.getElementById('gramPanchayat').value = schoolProfile.gramPanchayat || '';
                document.getElementById('pinCode').value = schoolProfile.pinCode || '';
                document.getElementById('diseCode').value = schoolProfile.diseCode || '';
                document.getElementById('schoolNumber').value = schoolProfile.schoolNumber || '';
            }
        }
        
        async function saveSchoolProfile() {
            const schoolProfileData = {
                username: currentUser,
                schoolName: document.getElementById('schoolName').value,
                circle: document.getElementById('circle').value,
                villageWard: document.getElementById('villageWard').value,
                policeStation: document.getElementById('policeStation').value,
                postOffice: document.getElementById('postOffice').value,
                gramPanchayat: document.getElementById('gramPanchayat').value,
                pinCode: document.getElementById('pinCode').value,
                diseCode: document.getElementById('diseCode').value,
                schoolNumber: document.getElementById('schoolNumber').value
            };
            
            // Validate PIN code
            if (!validatePIN(schoolProfileData.pinCode)) {
                showMessage('Please enter a valid 6-digit PIN code.', 'error');
                return;
            }
            
            // We need user ID to save - use the one from login
            if (!userData || !userData.userId) {
                showMessage('User not logged in properly.', 'error');
                return;
            }
            
            schoolProfileData.id = userData.userId;
            
            try {
                // Use saveSchoolProfile endpoint if it exists, otherwise use fallback
                const result = await callAPI('saveSchoolProfile', schoolProfileData);
                
                if (result.success) {
                    schoolProfile = schoolProfileData;
                    appState.profileComplete = true;
                    showMessage('School profile saved successfully!', 'success');
                    updateDashboard();
                    showView('dashboardView');
                } else {
                    // Try alternative approach
                    showMessage('Saving school profile...', 'info');
                    // Store locally for now
                    schoolProfile = schoolProfileData;
                    appState.profileComplete = true;
                    showMessage('School profile saved locally!', 'success');
                    updateDashboard();
                    showView('dashboardView');
                }
            } catch (error) {
                console.error('Error saving school profile:', error);
                // Store locally
                schoolProfile = schoolProfileData;
                appState.profileComplete = true;
                showMessage('School profile saved locally!', 'success');
                updateDashboard();
                showView('dashboardView');
            }
        }
        
        // =============== TEACHERS FUNCTIONS ===============
        function renderTeachersTable() {
            if (teachers.length === 0) {
                elements.noTeachersRow.style.display = '';
                return;
            }
            
            elements.noTeachersRow.style.display = 'none';
            elements.teachersTableBody.innerHTML = '';
            
            teachers.forEach((teacher, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teacher.Name || teacher.name}</td>
                    <td>${teacher.Designation || teacher.designation}</td>
                    <td>${teacher.Qualification || teacher.qualification}</td>
                    <td>${teacher.DOB || teacher.dob}</td>
                    <td>${teacher['First Join'] || teacher.doj}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 0.9rem;" onclick="editTeacher(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.9rem; margin-left: 5px;" onclick="deleteTeacher(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                elements.teachersTableBody.appendChild(row);
            });
        }
        
        window.editTeacher = function(index) {
            const teacher = teachers[index];
            // Show form and populate with teacher data
            elements.teacherFormContainer.classList.remove('hidden');
            document.getElementById('teacherName').value = teacher.Name || teacher.name;
            document.getElementById('designation').value = teacher.Designation || teacher.designation;
            document.getElementById('qualification').value = teacher.Qualification || teacher.qualification;
            document.getElementById('dob').value = teacher.DOB || teacher.dob;
            document.getElementById('doj').value = teacher['First Join'] || teacher.doj;
            document.getElementById('remarks').value = teacher.Remarks || teacher.remarks || '';
            
            // Set current editing index
            elements.teacherForm.dataset.editingIndex = index;
            window.scrollTo({ top: elements.teacherFormContainer.offsetTop - 100, behavior: 'smooth' });
        };
        
        window.deleteTeacher = function(index) {
            if (confirm('Are you sure you want to delete this teacher?')) {
                teachers.splice(index, 1);
                renderTeachersTable();
                showMessage('Teacher deleted.', 'info');
                
                if (teachers.length === 0) {
                    appState.teachersComplete = false;
                    updateDashboard();
                }
            }
        };
        
        async function saveTeachers() {
            if (teachers.length === 0) {
                showMessage('Please add at least one teacher.', 'error');
                return;
            }
            
            showMessage('Saving teachers locally...', 'info');
            
            // Store locally for now
            appState.teachersComplete = true;
            showMessage('Teachers saved locally!', 'success');
            updateDashboard();
            showView('dashboardView');
        }
        
        // =============== STUDENTS FUNCTIONS ===============
        function loadStudentsForm() {
            const classes = ['Pre-Primary', 'Class I', 'Class II', 'Class III', 'Class IV', 'Class V'];
            elements.studentsTableBody.innerHTML = '';
            
            classes.forEach((className, index) => {
                // Try to find existing data
                let existingData = null;
                if (students && students.length > 0) {
                    existingData = students.find(s => s.Class === className);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${className}</strong></td>
                    <td>
                        <input type="number" min="0" class="boys-input" data-class="${className}" 
                               value="${existingData ? (existingData.Open_Boys || existingData.Close_Boys || 0) : 0}" placeholder="0">
                    </td>
                    <td>
                        <input type="number" min="0" class="girls-input" data-class="${className}" 
                               value="${existingData ? (existingData.Open_Girls || existingData.Close_Girls || 0) : 0}" placeholder="0">
                    </td>
                    <td class="class-total" id="total-${index}">
                        ${existingData ? (parseInt(existingData.Open_Boys || 0) + parseInt(existingData.Open_Girls || 0)) : 0}
                    </td>
                    <td>
                        <input type="text" class="remarks-input" data-class="${className}" 
                               value="" placeholder="Optional">
                    </td>
                `;
                elements.studentsTableBody.appendChild(row);
            });
            
            updateTotals();
            
            // Add event listeners to inputs
            document.querySelectorAll('.boys-input, .girls-input').forEach(input => {
                input.addEventListener('input', updateTotals);
            });
        }
        
        function updateTotals() {
            let totalBoys = 0;
            let totalGirls = 0;
            let totalStudents = 0;
            
            document.querySelectorAll('.boys-input').forEach((input, index) => {
                const boys = parseInt(input.value) || 0;
                const girls = parseInt(document.querySelectorAll('.girls-input')[index].value) || 0;
                const classTotal = boys + girls;
                
                totalBoys += boys;
                totalGirls += girls;
                totalStudents += classTotal;
                
                // Update class total
                document.getElementById(`total-${index}`).textContent = classTotal;
            });
            
            elements.totalBoys.textContent = totalBoys;
            elements.totalGirls.textContent = totalGirls;
            elements.totalStudents.textContent = totalStudents;
        }
        
        async function saveStudentsData() {
            const studentsData = [];
            
            document.querySelectorAll('.boys-input').forEach(input => {
                const className = input.getAttribute('data-class');
                const boys = parseInt(input.value) || 0;
                const girls = parseInt(document.querySelector(`.girls-input[data-class="${className}"]`).value) || 0;
                const remarks = document.querySelector(`.remarks-input[data-class="${className}"]`).value;
                
                studentsData.push({
                    class: className,
                    boys: boys,
                    girls: girls,
                    total: boys + girls,
                    remarks: remarks
                });
            });
            
            showMessage('Student data saved locally!', 'success');
            
            students = studentsData;
            appState.studentsComplete = true;
            updateDashboard();
            showView('dashboardView');
        }
        
        // =============== PDF PREVIEW FUNCTIONS ===============
        function updatePdfPreviewStatus() {
            // Update task status in preview
            elements.previewTask1.textContent = `${appState.profileComplete ? '✅' : '❌'} School Profile`;
            elements.previewTask2.textContent = `${appState.teachersComplete ? '✅' : '❌'} Teacher Details`;
            elements.previewTask3.textContent = `${appState.studentsComplete ? '✅' : '❌'} Student Data`;
            
            // Show/hide preview container
            if (appState.profileComplete && appState.teachersComplete && appState.studentsComplete) {
                elements.previewStatus.classList.add('hidden');
                elements.previewContainer.classList.remove('hidden');
                updatePdfPreview();
            } else {
                elements.previewStatus.classList.remove('hidden');
                elements.previewContainer.classList.add('hidden');
            }
        }
        
        function updatePdfPreview() {
            if (!schoolProfile) return;
            
            // Update school info
            document.getElementById('pdfSchoolName').textContent = schoolProfile.schoolName;
            document.getElementById('pdfCircle').textContent = schoolProfile.circle;
            document.getElementById('pdfVillageWard').textContent = schoolProfile.villageWard;
            document.getElementById('pdfPoliceStation').textContent = schoolProfile.policeStation;
            document.getElementById('pdfPostOffice').textContent = schoolProfile.postOffice;
            document.getElementById('pdfGramPanchayat').textContent = schoolProfile.gramPanchayat;
            document.getElementById('pdfPinCode').textContent = schoolProfile.pinCode;
            document.getElementById('pdfDiseCode').textContent = schoolProfile.diseCode;
            document.getElementById('pdfSchoolNumber').textContent = schoolProfile.schoolNumber;
            
            // Update month/year
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
            document.getElementById('pdfMonthYear').textContent = 
                `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            
            // Update teachers table
            const teachersTable = document.getElementById('pdfTeachersTable');
            teachersTable.innerHTML = '';
            
            if (teachers.length > 0) {
                teachers.forEach((teacher, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${teacher.Name || teacher.name}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${teacher.Designation || teacher.designation}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${teacher.Qualification || teacher.qualification}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${teacher.DOB || teacher.dob}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${teacher['First Join'] || teacher.doj}</td>
                    `;
                    teachersTable.appendChild(row);
                });
            } else {
                teachersTable.innerHTML = `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;" colspan="6">No teacher data available</td>
                    </tr>
                `;
            }
            
            // Update students table
            const studentsTable = document.getElementById('pdfStudentsTable');
            studentsTable.innerHTML = '';
            
            if (students.length > 0) {
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="border: 1px solid #ccc; padding: 8px;">${student.class || student.Class}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${student.boys || student.Open_Boys || 0}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${student.girls || student.Open_Girls || 0}</td>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${student.total || (parseInt(student.boys || 0) + parseInt(student.girls || 0))}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${student.remarks || ''}</td>
                    `;
                    studentsTable.appendChild(row);
                });
            } else {
                studentsTable.innerHTML = `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;" colspan="5">No student data available</td>
                    </tr>
                `;
            }
        }
        
        async function generatePdf() {
            showLoading('Generating PDF...');
            
            try {
                showMessage('PDF generation placeholder - Feature coming soon', 'info');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Network error. Please try again.', 'error');
            }
        }
        
        // =============== EVENT LISTENERS ===============
        // Mobile menu toggle
        elements.mobileMenuBtn.addEventListener('click', () => {
            elements.sidebar.classList.toggle('active');
        });
        
        // Navigation
        elements.navItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewName = item.getAttribute('data-view');
                showView(`${viewName}View`);
            });
        });
        
        // Logout
        elements.logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                switchToLoggedOutState();
            }
        });
        
        // Back buttons
        elements.backToDashboard.addEventListener('click', () => showView('dashboardView'));
        elements.backToDashboard2.addEventListener('click', () => showView('dashboardView'));
        elements.backToDashboard3.addEventListener('click', () => showView('dashboardView'));
        elements.backToDashboard4.addEventListener('click', () => showView('dashboardView'));
        
        // Task buttons
        elements.profileBtn.addEventListener('click', () => showView('schoolProfileView'));
        elements.teacherBtn.addEventListener('click', () => showView('teachersView'));
        elements.studentBtn.addEventListener('click', () => showView('studentsView'));
        
        // Cancel buttons
        elements.cancelSchoolProfile.addEventListener('click', () => showView('dashboardView'));
        elements.cancelTeacherBtn.addEventListener('click', () => {
            elements.teacherFormContainer.classList.add('hidden');
            elements.teacherForm.reset();
            delete elements.teacherForm.dataset.editingIndex;
        });
        
        // Save buttons
        elements.schoolProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveSchoolProfile();
        });
        
        elements.teacherForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const teacherData = {
                name: document.getElementById('teacherName').value,
                designation: document.getElementById('designation').value,
                qualification: document.getElementById('qualification').value,
                dob: document.getElementById('dob').value,
                doj: document.getElementById('doj').value,
                remarks: document.getElementById('remarks').value
            };
            
            // Validate
            if (!teacherData.name || !teacherData.designation || !teacherData.qualification || 
                !teacherData.dob || !teacherData.doj) {
                showMessage('Please fill all required fields.', 'error');
                return;
            }
            
            // Check if editing or adding new
            const editingIndex = elements.teacherForm.dataset.editingIndex;
            if (editingIndex !== undefined) {
                teachers[editingIndex] = teacherData;
                delete elements.teacherForm.dataset.editingIndex;
            } else {
                teachers.push(teacherData);
            }
            
            renderTeachersTable();
            elements.teacherFormContainer.classList.add('hidden');
            elements.teacherForm.reset();
            
            showMessage('Teacher saved.', 'success');
        });
        
        elements.addTeacherBtn.addEventListener('click', () => {
            elements.teacherFormContainer.classList.remove('hidden');
            elements.teacherForm.reset();
            delete elements.teacherForm.dataset.editingIndex;
            window.scrollTo({ top: elements.teacherFormContainer.offsetTop - 100, behavior: 'smooth' });
        });
        
        elements.saveTeachersBtn.addEventListener('click', saveTeachers);
        
        elements.studentsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveStudentsData();
        });
        
        // PDF Preview
        elements.refreshPreviewBtn.addEventListener('click', () => {
            updatePdfPreview();
            showMessage('Preview refreshed.', 'info');
        });
        
        elements.generatePdfBtn.addEventListener('click', generatePdf);
        
        // =============== LOGIN/REGISTRATION HANDLERS ===============
        // Password toggle
        elements.loginPasswordToggle.addEventListener('click', () => {
            togglePasswordVisibility('loginPassword', elements.loginPasswordToggle);
        });
        
        elements.regPasswordToggle.addEventListener('click', () => {
            togglePasswordVisibility('regPassword', elements.regPasswordToggle);
        });
        
        function togglePasswordVisibility(inputId, toggleIcon) {
            const passwordInput = document.getElementById(inputId);
            const icon = toggleIcon.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding form
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-form`) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // Forgot password link
        elements.forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('forgot-form').classList.add('active');
        });
        
        // Back to login
        elements.backToLogin.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-tab="login"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('login-form').classList.add('active');
        });
        
        // Login form
        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = elements.loginUser.value.trim();
            const password = elements.loginPassword.value;
            
            if (!username || !password) {
                showMessage('Please enter username and password.', 'error');
                return;
            }
            
            try {
                const result = await callAPI('login', { username, password });
                
                if (result.success && result.user) {
                    currentUser = username;
                    userData = {
                        username: username,
                        mobile: result.user.Mobile || '',
                        email: result.user.Email || '',
                        createdAt: result.user.create_date || '',
                        userId: result.user.id,
                        profile_done: result.user.profile_done || false,
                        teacher_done: result.user.teacher_done || false,
                        student_done: result.user.student_done || false
                    };
                    
                    showMessage('Login successful!', 'success');
                    
                    // Load user data with the user ID
                    await loadUserData(result.user.id);
                    
                    // Switch to logged in state
                    setTimeout(() => {
                        switchToLoggedInState();
                    }, 1000);
                } else {
                    showMessage(result.message || 'Login failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Network error. Please try again.', 'error');
            }
        });
        
        // Registration form
        elements.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = elements.regUser.value.trim();
            const password = elements.regPassword.value;
            const mobile = elements.regMobile.value.trim();
            const email = elements.regEmail.value.trim();
            
            // Validation
            if (username.length < 3) {
                showMessage('Username must be at least 3 characters.', 'error');
                return;
            }
            
            if (!validatePassword(password)) {
                showMessage('Password must be 5 to 10 characters.', 'error');
                return;
            }
            
            if (!validateMobile(mobile)) {
                showMessage('Please enter a valid 10-digit mobile number.', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showMessage('Please enter a valid email address.', 'error');
                return;
            }
            
            try {
                const result = await callAPI('register', { username, password, mobile, email });
                
                if (result.success) {
                    showMessage('Account created successfully! Welcome email sent.', 'success');
                    
                    // Switch to login tab
                    setTimeout(() => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelector('.tab[data-tab="login"]').classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById('login-form').classList.add('active');
                        
                        // Auto-fill login form
                        elements.loginUser.value = username;
                        elements.loginPassword.value = '';
                        elements.registerForm.reset();
                    }, 2000);
                } else {
                    showMessage(result.message || 'Account creation failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('Network error. Please try again.', 'error');
            }
        });
        
        // Forgot password form
        elements.forgotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const mobile = elements.forgotMobile.value.trim();
            const email = elements.forgotEmail.value.trim();
            
            if (!validateMobile(mobile)) {
                showMessage('Please enter a valid 10-digit mobile number.', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showMessage('Please enter a valid email address.', 'error');
                return;
            }
            
            try {
                const result = await callAPI('forgot', { mobile, email });
                
                if (result.success) {
                    showMessage('Your username and password have been sent to your email.', 'success');
                    elements.forgotForm.reset();
                    
                    setTimeout(() => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelector('.tab[data-tab="login"]').classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById('login-form').classList.add('active');
                    }, 3000);
                } else {
                    showMessage(result.message || 'Email or mobile number not found.', 'error');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                showMessage('Network error. Please try again.', 'error');
            }
        });
        
        // =============== INITIALIZATION ===============
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Monthly Return Maker v' + APP_VERSION + ' loaded');
            
            // Check if user is already logged in (from localStorage)
            const savedUser = localStorage.getItem('mr_username');
            if (savedUser) {
                // We'll need to login again to get fresh data
                showMessage('Please login again.', 'info');
            }
            
            // Initialize students form
            loadStudentsForm();
        });
        
        // Window resize handler
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                elements.sidebar.style.transform = 'translateX(0)';
                elements.mainContent.style.marginLeft = currentUser ? '260px' : '0';
            } else {
                if (!elements.sidebar.classList.contains('active')) {
                    elements.mainContent.style.marginLeft = '0';
                }
            }
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                elements.sidebar.classList.contains('active') &&
                !elements.sidebar.contains(e.target) &&
                !elements.mobileMenuBtn.contains(e.target)) {
                elements.sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>