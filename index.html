<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Return Maker</title>
    
    <!-- Bengali Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Noto Sans Bengali', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .bengali {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a5f7a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Message System */
        #messageContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
        
        /* Custom Colors */
        .bg-primary-custom {
            background-color: #1a5f7a !important;
        }
        
        .btn-primary-custom {
            background-color: #1a5f7a;
            border-color: #1a5f7a;
        }
        
        .btn-primary-custom:hover {
            background-color: #14495c;
            border-color: #14495c;
        }
        
        /* Table Styles */
        .table-custom th {
            background-color: #1a5f7a;
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }
        
        /* ============== FIX FOR TEXT COLOR ============== */
        .form-control, .form-select {
            color: #333 !important;
        }
        
        .alert-success {
            color: #0f5132 !important;
        }
        
        .alert-danger {
            color: #842029 !important;
        }
        
        .alert-info {
            color: #055160 !important;
        }
        
        .alert-warning {
            color: #664d03 !important;
        }
        
        .form-control::placeholder {
            color: #6c757d !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner mb-3"></div>
        <div id="loadingText">Loading...</div>
    </div>
    
    <!-- Message Container -->
    <div id="messageContainer"></div>
    
    <!-- Main App Container -->
    <div id="appContainer">
        <!-- Login/Registration View -->
        <div class="view active" id="loginView">
            <div class="container">
                <div class="row justify-content-center min-vh-100 align-items-center">
                    <div class="col-md-6 col-lg-5">
                        <div class="text-center mb-5">
                            <h1 class="text-primary-custom fw-bold">Monthly Return Maker</h1>
                            <p class="text-muted bengali">প্রাথমিক বিদ্যালয়ের মাসিক প্রতিবেদন প্রস্তুতকারী</p>
                        </div>
                        
                        <div class="card shadow-lg">
                            <div class="card-header bg-primary-custom text-white">
                                <ul class="nav nav-tabs card-header-tabs" id="authTabs">
                                    <li class="nav-item">
                                        <button class="nav-link active text-white" id="login-tab" data-bs-toggle="tab" data-bs-target="#loginForm">Login</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link text-white" id="register-tab" data-bs-toggle="tab" data-bs-target="#registerForm">Register</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link text-white" id="forgot-tab" data-bs-toggle="tab" data-bs-target="#forgotForm">Forgot Password</button>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="card-body p-4">
                                <div class="tab-content">
                                    <!-- Login Form -->
                                    <div class="tab-pane fade show active" id="loginForm">
                                        <form id="loginFormElement">
                                            <div class="mb-3">
                                                <label for="loginMobile" class="form-label">Mobile Number (Username)</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                                                    <input type="tel" class="form-control" id="loginMobile" 
                                                           placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="loginPassword" class="form-label">Password</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                                    <input type="password" class="form-control" id="loginPassword" 
                                                           placeholder="Enter password" required>
                                                    <button class="btn btn-outline-secondary" type="button" id="toggleLoginPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary-custom w-100 mb-3">Login</button>
                                            
                                            <div class="text-center">
                                                <a href="#" class="text-decoration-none" onclick="showTab('forgot-tab')">
                                                    <small>Forgot username or password?</small>
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Registration Form -->
                                    <div class="tab-pane fade" id="registerForm">
                                        <form id="registerFormElement">
                                            <div class="mb-3">
                                                <label for="regMobile" class="form-label">Mobile Number <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                                                    <input type="tel" class="form-control" id="regMobile" 
                                                           placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
                                                </div>
                                                <small class="form-text text-muted">This will be your username</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="regPassword" class="form-label">Password <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                                    <input type="password" class="form-control" id="regPassword" 
                                                           placeholder="5-10 characters" minlength="5" maxlength="10" required>
                                                    <button class="btn btn-outline-secondary" type="button" id="toggleRegPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="regEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                    <input type="email" class="form-control" id="regEmail" 
                                                           placeholder="Your email address" required>
                                                </div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary-custom w-100">Create Account</button>
                                        </form>
                                    </div>
                                    
                                    <!-- Forgot Password Form -->
                                    <div class="tab-pane fade" id="forgotForm">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Enter your mobile number and email. We will send your username and password.
                                        </div>
                                        
                                        <form id="forgotFormElement">
                                            <div class="mb-3">
                                                <label for="forgotMobile" class="form-label">Mobile Number</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                                                    <input type="tel" class="form-control" id="forgotMobile" 
                                                           placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="forgotEmail" class="form-label">Email Address</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                    <input type="email" class="form-control" id="forgotEmail" 
                                                           placeholder="Your email address" required>
                                                </div>
                                            </div>
                                            
                                            <div class="d-grid gap-2">
                                                <button type="submit" class="btn btn-primary-custom">Send Credentials</button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="showTab('login-tab')">
                                                    Back to Login
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4 text-muted">
                            <p class="small">© 2026 Monthly Return Maker</p>
                            <p class="small bengali">তৈরি করেছেন: সুমিত | সমস্ত ডেটা সুরক্ষিত</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard View (Visible after login) -->
        <div class="view" id="dashboardView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom">
                <div class="container-fluid">
                    <a class="navbar-brand bengali" href="#">
                        <i class="fas fa-school me-2"></i> মাসিক প্রতিবেদন
                    </a>
                    
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto">
                            <li class="nav-item">
                                <button class="nav-link active" onclick="showView('dashboardView')">
                                    <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" onclick="showView('makeReturnView')" id="makeReturnBtn">
                                    <i class="fas fa-file-alt me-1"></i> Make Monthly Return
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" onclick="showView('previousReturnsView')">
                                    <i class="fas fa-history me-1"></i> Previous Returns
                                </button>
                            </li>
                        </ul>
                        
                        <div class="navbar-text me-3 text-white">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUserMobile">User</span>
                        </div>
                        
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>
            
            <div class="container mt-4">
                <!-- Welcome Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="card-title text-primary-custom">Welcome to Monthly Return Maker</h3>
                        <p class="card-text bengali">আপনার বিদ্যালয়ের মাসিক প্রতিবেদন তৈরি করতে নিচের ৩টি ধাপ সম্পন্ন করুন</p>
                    </div>
                </div>
                
                <!-- Progress Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary-custom text-white">
                        <h5 class="mb-0">Completion Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Overall Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Task 1: School Profile -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-warning d-inline-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px;">
                                                <i class="fas fa-school fa-2x text-white"></i>
                                            </div>
                                        </div>
                                        <h5 class="card-title">School Profile</h5>
                                        <p class="card-text small">Fill your school details and address</p>
                                        <div class="mb-2">
                                            <span class="badge" id="profileStatusBadge">Pending</span>
                                        </div>
                                        <button class="btn btn-primary-custom btn-sm" onclick="showView('schoolProfileView')">
                                            <i class="fas fa-edit me-1"></i> Complete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Task 2: Teachers -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-info d-inline-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px;">
                                                <i class="fas fa-chalkboard-teacher fa-2x text-white"></i>
                                            </div>
                                        </div>
                                        <h5 class="card-title">Teachers</h5>
                                        <p class="card-text small">Add at least one teacher</p>
                                        <div class="mb-2">
                                            <span class="badge" id="teacherStatusBadge">Pending</span>
                                        </div>
                                        <button class="btn btn-primary-custom btn-sm" id="teacherTaskBtn" onclick="showView('teachersView')" disabled>
                                            <i class="fas fa-plus me-1"></i> Add Teachers
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Task 3: Classes -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <div class="rounded-circle bg-success d-inline-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px;">
                                                <i class="fas fa-users fa-2x text-white"></i>
                                            </div>
                                        </div>
                                        <h5 class="card-title">Classes</h5>
                                        <p class="card-text small">Select active classes</p>
                                        <div class="mb-2">
                                            <span class="badge" id="classStatusBadge">Pending</span>
                                        </div>
                                        <button class="btn btn-primary-custom btn-sm" id="classTaskBtn" onclick="showView('classesView')" disabled>
                                            <i class="fas fa-check me-1"></i> Select Classes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header bg-primary-custom text-white">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-grid">
                                    <button class="btn btn-success btn-lg" onclick="showView('makeReturnView')" id="quickMakeReturnBtn" disabled>
                                        <i class="fas fa-file-pdf me-2"></i> Make Monthly Return
                                    </button>
                                    <small class="text-muted mt-1">Create a new monthly return for any month</small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary btn-lg" onclick="showView('previousReturnsView')">
                                        <i class="fas fa-history me-2"></i> View Previous Returns
                                    </button>
                                    <small class="text-muted mt-1">Access and download past monthly returns</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- School Profile View -->
        <div class="view" id="schoolProfileView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm me-2" onclick="showView('dashboardView')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <span class="navbar-brand bengali">বিদ্যালয়ের তথ্য</span>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4 class="mb-0"><i class="fas fa-school me-2"></i> School Information</h4>
                        <small class="bengali">এই তথ্যগুলো মাসিক প্রতিবেদনের হলুদ অংশে দেখাবে</small>
                    </div>
                    <div class="card-body">
                        <form id="schoolProfileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="schoolName" class="form-label">School Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="schoolName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="circle" class="form-label">Circle <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="circle" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="villageWard" class="form-label">Village / Ward <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="villageWard" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="policeStation" class="form-label">Police Station <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="policeStation" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="postOffice" class="form-label">Post Office <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="postOffice" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="gramPanchayat" class="form-label">Gram Panchayat / Municipality <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="gramPanchayat" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="pinCode" class="form-label">PIN Code <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="pinCode" pattern="[0-9]{6}" maxlength="6" required>
                                    <small class="form-text text-muted">6 digits</small>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="diseCode" class="form-label">DISE Code <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="diseCode" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="schoolNumber" class="form-label">School Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="schoolNumber" required>
                                    <small class="form-text text-muted bengali">(প্রতিবেদনে 57 এর পরিবর্তে দেখাবে)</small>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="showView('dashboardView')">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary-custom">
                                    <i class="fas fa-save me-1"></i> Save School Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Teachers View -->
        <div class="view" id="teachersView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm me-2" onclick="showView('dashboardView')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <span class="navbar-brand bengali">শিক্ষকদের তথ্য</span>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="fas fa-chalkboard-teacher me-2"></i> Teacher Details</h4>
                            <button class="btn btn-light btn-sm" onclick="showAddTeacherModal()">
                                <i class="fas fa-plus me-1"></i> Add Teacher
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="teachersTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>SL</th>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>Qualification</th>
                                        <th>Date of Birth</th>
                                        <th>Date of Joining</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="teachersTableBody">
                                    <!-- Teachers will be loaded here -->
                                    <tr id="noTeachersRow">
                                        <td colspan="7" class="text-center py-4 text-muted">
                                            <i class="fas fa-users fa-2x mb-3"></i>
                                            <p>No teachers added yet. Click "Add Teacher" to get started.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Classes View -->
        <div class="view" id="classesView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm me-2" onclick="showView('dashboardView')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <span class="navbar-brand bengali">ক্লাস নির্বাচন</span>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="fas fa-users me-2"></i> Select Active Classes</h4>
                        <small class="bengali">নিচের ক্লাসগুলোর মধ্যে বিদ্যালয়ে যে ক্লাসগুলো আছে সেগুলো নির্বাচন করুন</small>
                    </div>
                    <div class="card-body">
                        <form id="classesForm">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="classPrePrimary" value="Pre-Primary">
                                        <label class="form-check-label bengali" for="classPrePrimary">
                                            <strong>Pre-Primary</strong> (পূর্ব-প্রাথমিক)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="classI" value="Class I">
                                        <label class="form-check-label bengali" for="classI">
                                            <strong>Class I</strong> (প্রথম শ্রেণী)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="classII" value="Class II">
                                        <label class="form-check-label bengali" for="classII">
                                            <strong>Class II</strong> (দ্বিতীয় শ্রেণী)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="classIII" value="Class III">
                                        <label class="form-check-label bengali" for="classIII">
                                            <strong>Class III</strong> (তৃতীয় শ্রেণী)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="classIV" value="Class IV">
                                        <label class="form-check-label bengali" for="classIV">
                                            <strong>Class IV</strong> (চতুর্থ শ্রেণী)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="classV" value="Class V">
                                        <label class="form-check-label bengali" for="classV">
                                            <strong>Class V</strong> (পঞ্চম শ্রেণী)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>Note:</strong> You must select at least one class. You can change this selection each month.
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="showView('dashboardView')">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i> Save Class Selection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Make Monthly Return View -->
        <div class="view" id="makeReturnView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm me-2" onclick="showView('dashboardView')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <span class="navbar-brand bengali">মাসিক প্রতিবেদন তৈরি</span>
                </div>
            </nav>
            
            <div class="container mt-4">
                <!-- Month Selection -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Select Month and Year</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="selectMonth" class="form-label">Month</label>
                                <select class="form-select" id="selectMonth">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="selectYear" class="form-label">Year</label>
                                <select class="form-select" id="selectYear">
                                    <!-- Years will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="totalWorkingDays" class="form-label">Total Working Days <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="totalWorkingDays" min="1" max="31" required>
                                <small class="form-text text-muted">Enter total working days for this month (1-31)</small>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            You can create returns for past months only. Future months are not allowed.
                        </div>
                    </div>
                </div>
                
                <!-- Teacher Leaves Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary-custom text-white">
                        <h4 class="mb-0"><i class="fas fa-user-clock me-2"></i> Teacher Leave Details</h4>
                        <small class="bengali">প্রতিটি শিক্ষকের জন্য ছুটির তথ্য দিন</small>
                    </div>
                    <div class="card-body">
                        <div id="teacherLeavesContainer">
                            <!-- Teacher leaves table will be generated here -->
                            <div class="text-center py-4 text-muted" id="noTeachersForLeave">
                                <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                                <p>No teachers found. Please add teachers first from the Teachers section.</p>
                                <button class="btn btn-primary-custom" onclick="showView('teachersView')">
                                    <i class="fas fa-plus me-1"></i> Add Teachers
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Student Data Section -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0"><i class="fas fa-user-graduate me-2"></i> Student Data</h4>
                        <small class="bengali">প্রতিটি সক্রিয় ক্লাসের জন্য ছাত্রছাত্রীর সংখ্যা দিন</small>
                    </div>
                    <div class="card-body">
                        <div id="studentDataContainer">
                            <!-- Student data form will be generated here -->
                            <div class="text-center py-4 text-muted" id="noClassesForStudent">
                                <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                                <p>No classes selected. Please select classes first from the Classes section.</p>
                                <button class="btn btn-info" onclick="showView('classesView')">
                                    <i class="fas fa-check me-1"></i> Select Classes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Button -->
                <div class="card">
                    <div class="card-body text-center">
                        <button class="btn btn-success btn-lg" id="generatePdfBtn" disabled>
                            <i class="fas fa-file-pdf me-2"></i> Generate Monthly Return PDF
                        </button>
                        <p class="text-muted mt-2">All data will be saved to database. PDF will download automatically.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Previous Returns View -->
        <div class="view" id="previousReturnsView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm me-2" onclick="showView('dashboardView')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <span class="navbar-brand bengali">পূর্বের প্রতিবেদনসমূহ</span>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h4 class="mb-0"><i class="fas fa-history me-2"></i> Previous Monthly Returns</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="previousReturnsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Month/Year</th>
                                        <th>Generated On</th>
                                        <th>Working Days</th>
                                        <th>Teachers</th>
                                        <th>Pages</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="previousReturnsTableBody">
                                    <!-- Previous returns will be loaded here -->
                                    <tr id="noReturnsRow">
                                        <td colspan="7" class="text-center py-4 text-muted">
                                            <i class="fas fa-file-alt fa-2x mb-3"></i>
                                            <p>No monthly returns generated yet.</p>
                                            <button class="btn btn-primary-custom" onclick="showView('makeReturnView')">
                                                <i class="fas fa-plus me-1"></i> Create First Return
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin View (Only for admin users) -->
        <div class="view" id="adminView">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm me-2" onclick="showView('dashboardView')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <span class="navbar-brand">Admin Panel</span>
                </div>
            </nav>
            
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h4 class="mb-0"><i class="fas fa-user-shield me-2"></i> School Management</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="adminSchoolsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>School Name</th>
                                        <th>Mobile</th>
                                        <th>Circle</th>
                                        <th>Village</th>
                                        <th>Teachers</th>
                                        <th>Last Return</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminSchoolsTableBody">
                                    <!-- Schools data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Add/Edit Teacher Modal -->
    <div class="modal fade" id="teacherModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title" id="teacherModalTitle">Add New Teacher</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="teacherForm">
                        <input type="hidden" id="teacherEditId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="teacherName" class="form-label">Teacher Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teacherName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="teacherDesignation" class="form-label">Designation <span class="text-danger">*</span></label>
                                <select class="form-select" id="teacherDesignation" required>
                                    <option value="">Select</option>
                                    <option value="Head Teacher">Head Teacher (HT)</option>
                                    <option value="Assistant Teacher">Assistant Teacher (AT)</option>
                                    <option value="SMC Teacher">SMC Teacher</option>
                                    <option value="Guest Teacher">Guest Teacher</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="teacherQualification" class="form-label">Qualification <span class="text-danger">*</span></label>
                                <select class="form-select" id="teacherQualification" required>
                                    <option value="">Select</option>
                                    <option value="Below Secondary">Below Secondary</option>
                                    <option value="Secondary">Secondary</option>
                                    <option value="Higher Secondary">Higher Secondary</option>
                                    <option value="Graduate">Graduate</option>
                                    <option value="Post Graduate">Post Graduate</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="teacherTraining" class="form-label">Training (Optional)</label>
                                <input type="text" class="form-control" id="teacherTraining">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="teacherDOB" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="teacherDOB" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="teacherROPA" class="form-label">ROPA-19 Salary</label>
                                <input type="number" class="form-control" id="teacherROPA" min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="teacherRetirement" class="form-label">Retirement Date</label>
                                <input type="date" class="form-control" id="teacherRetirement">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="teacherFirstJoin" class="form-label">First Joining Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="teacherFirstJoin" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="teacherDistrictJoin" class="form-label">District Joining Date</label>
                                <input type="date" class="form-control" id="teacherDistrictJoin">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="teacherSchoolJoin" class="form-label">Present School Joining Date</label>
                                <input type="date" class="form-control" id="teacherSchoolJoin">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveTeacher()">Save Teacher</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Previous Return Modal -->
    <div class="modal fade" id="editReturnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Edit Monthly Return</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReturnForm">
                        <input type="hidden" id="editReturnId">
                        
                        <div class="mb-3">
                            <label for="editCorrectionNote" class="form-label">Correction Note <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editCorrectionNote" rows="3" required 
                                      placeholder="Please describe what corrections you are making..."></textarea>
                            <small class="form-text text-muted">This note will appear at the bottom of the PDF</small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Editing will create a new version of this monthly return with your corrections.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="confirmEditReturn()">Proceed to Edit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View School Details Modal (Admin) -->
    <div class="modal fade" id="viewSchoolModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title">School Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="schoolDetailsContent">
                        <!-- School details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Configuration
        const APP_VERSION = '1.0.0';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJ0vDpC58Ajc9pcI9TAgOh2KoGgdGcJFCKv5K-se8i9d99_27q3YB4WTlKqhbtsXzo/exec';
        
        // Application State
        let currentUser = null;
        let userData = null;
        let schoolProfile = null;
        let teachers = [];
        let selectedClasses = [];
        let currentMonthData = null;
        
        // DOM Elements
        const elements = {
            views: document.querySelectorAll('.view'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            messageContainer: document.getElementById('messageContainer'),
            
            // Login elements
            loginMobile: document.getElementById('loginMobile'),
            loginPassword: document.getElementById('loginPassword'),
            regMobile: document.getElementById('regMobile'),
            regPassword: document.getElementById('regPassword'),
            regEmail: document.getElementById('regEmail'),
            forgotMobile: document.getElementById('forgotMobile'),
            forgotEmail: document.getElementById('forgotEmail'),
            
            // Dashboard elements
            currentUserMobile: document.getElementById('currentUserMobile'),
            progressBar: document.getElementById('progressBar'),
            progressPercent: document.getElementById('progressPercent'),
            profileStatusBadge: document.getElementById('profileStatusBadge'),
            teacherStatusBadge: document.getElementById('teacherStatusBadge'),
            classStatusBadge: document.getElementById('classStatusBadge'),
            teacherTaskBtn: document.getElementById('teacherTaskBtn'),
            classTaskBtn: document.getElementById('classTaskBtn'),
            quickMakeReturnBtn: document.getElementById('quickMakeReturnBtn'),
            makeReturnBtn: document.getElementById('makeReturnBtn'),
            
            // Teacher elements
            teachersTableBody: document.getElementById('teachersTableBody'),
            noTeachersRow: document.getElementById('noTeachersRow'),
            
            // Monthly return elements
            selectYear: document.getElementById('selectYear'),
            totalWorkingDays: document.getElementById('totalWorkingDays'),
            teacherLeavesContainer: document.getElementById('teacherLeavesContainer'),
            noTeachersForLeave: document.getElementById('noTeachersForLeave'),
            studentDataContainer: document.getElementById('studentDataContainer'),
            noClassesForStudent: document.getElementById('noClassesForStudent'),
            generatePdfBtn: document.getElementById('generatePdfBtn')
        };
        
        // =============== UTILITY FUNCTIONS ===============
        
        function showLoading(message = 'Loading...') {
            elements.loadingText.textContent = message;
            elements.loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            elements.loadingOverlay.style.display = 'none';
        }
        
        function showMessage(text, type = 'info') {
            const alertTypes = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertTypes[type]} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            elements.messageContainer.innerHTML = '';
            elements.messageContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function showView(viewId) {
            // Hide all views
            elements.views.forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }
            
            // Load data if needed
            if (viewId === 'dashboardView') {
                updateDashboard();
            } else if (viewId === 'previousReturnsView') {
                loadPreviousReturns();
            } else if (viewId === 'adminView') {
                loadAdminData();
            }
        }
        
        function showTab(tabId) {
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
            }
        }
        
        // =============== VALIDATION FUNCTIONS ===============
        
        function validateMobile(mobile) {
            const cleanMobile = String(mobile).trim();
            if (!/^\d{10}$/.test(cleanMobile)) {
                throw new Error('Mobile number must be exactly 10 digits');
            }
            return cleanMobile;
        }
        
        function validateEmail(email) {
            const cleanEmail = String(email).trim().toLowerCase();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cleanEmail)) {
                throw new Error('Please enter a valid email address');
            }
            return cleanEmail;
        }
        
        function validatePassword(password) {
            if (password.length < 5 || password.length > 10) {
                throw new Error('Password must be 5-10 characters');
            }
            return password;
        }
        
        // =============== API FUNCTIONS ===============
        
        async function callAPI(action, data = null) {
            showLoading('Processing...');
            
            try {
                let url = `${SCRIPT_URL}?action=${action}`;
                
                // For GET requests
                if (!data) {
                    const response = await fetch(url);
                    const result = await response.json();
                    hideLoading();
                    return result;
                }
                
                // For POST requests
                const formData = new FormData();
                for (const key in data) {
                    formData.append(key, data[key]);
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideLoading();
                return result;
                
            } catch (error) {
                hideLoading();
                console.error('API Error:', error);
                showMessage('Network error. Please check your internet connection.', 'error');
                return { success: false, message: 'Network error: ' + error.message };
            }
        }
        
        // =============== AUTHENTICATION ===============
        
        async function login(mobile, password) {
            try {
                const result = await callAPI('login', { mobile, password });
                
                if (result.success && result.user) {
                    currentUser = mobile;
                    userData = result.user;
                    
                    // Update UI
                    elements.currentUserMobile.textContent = mobile;
                    
                    // Load user data
                    await loadUserData();
                    
                    showMessage('Login successful!', 'success');
                    showView('dashboardView');
                    
                } else {
                    showMessage(result.message || 'Login failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login error. Please try again.', 'error');
            }
        }
        
        async function register(mobile, password, email) {
            try {
                // Validate inputs
                validateMobile(mobile);
                validatePassword(password);
                validateEmail(email);
                
                const result = await callAPI('register', { 
                    mobile, 
                    password, 
                    email 
                });
                
                if (result.success) {
                    showMessage('Account created successfully! Check your email for details.', 'success');
                    
                    // Switch to login tab
                    setTimeout(() => {
                        showTab('login-tab');
                        elements.loginMobile.value = mobile;
                        elements.loginPassword.value = '';
                    }, 2000);
                    
                } else {
                    showMessage(result.message || 'Registration failed. Please try again.', 'error');
                }
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }
        
        async function forgotPassword(mobile, email) {
            try {
                validateMobile(mobile);
                validateEmail(email);
                
                const result = await callAPI('forgot', { mobile, email });
                
                if (result.success) {
                    showMessage('Your credentials have been sent to your email.', 'success');
                    setTimeout(() => showTab('login-tab'), 3000);
                } else {
                    showMessage(result.message || 'Mobile or email not found.', 'error');
                }
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                userData = null;
                schoolProfile = null;
                teachers = [];
                selectedClasses = [];
                currentMonthData = null;
                
                showView('loginView');
                showMessage('Logged out successfully.', 'info');
            }
        }
        
        // =============== USER DATA MANAGEMENT ===============
        
        async function loadUserData() {
            try {
                // Load school profile
                const profileResult = await callAPI('getSchoolProfile', { mobile: currentUser });
                if (profileResult.success && profileResult.profile) {
                    schoolProfile = profileResult.profile;
                    loadSchoolProfileForm();
                }
                
                // Load teachers
                const teachersResult = await callAPI('getTeachers', { mobile: currentUser });
                if (teachersResult.success && teachersResult.teachers) {
                    teachers = teachersResult.teachers;
                    renderTeachersTable();
                }
                
                // Load selected classes
                const classesResult = await callAPI('getSelectedClasses', { mobile: currentUser });
                if (classesResult.success && classesResult.classes) {
                    selectedClasses = classesResult.classes;
                    loadClassesForm();
                }
                
                // Update dashboard
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // =============== DASHBOARD FUNCTIONS ===============
        
        function updateDashboard() {
            // Calculate progress
            let completedTasks = 0;
            if (schoolProfile) completedTasks++;
            if (teachers.length > 0) completedTasks++;
            if (selectedClasses.length > 0) completedTasks++;
            
            const progressPercent = Math.round((completedTasks / 3) * 100);
            
            // Update progress bar
            elements.progressBar.style.width = `${progressPercent}%`;
            elements.progressPercent.textContent = `${progressPercent}%`;
            
            // Update badges
            updateBadge('profileStatusBadge', schoolProfile, 'School Profile');
            updateBadge('teacherStatusBadge', teachers.length > 0, 'Teachers');
            updateBadge('classStatusBadge', selectedClasses.length > 0, 'Classes');
            
            // Enable/disable buttons
            elements.teacherTaskBtn.disabled = !schoolProfile;
            elements.classTaskBtn.disabled = teachers.length === 0;
            elements.quickMakeReturnBtn.disabled = completedTasks < 3;
            elements.makeReturnBtn.disabled = completedTasks < 3;
        }
        
        function updateBadge(elementId, condition, taskName) {
            const badge = document.getElementById(elementId);
            if (condition) {
                badge.textContent = 'COMPLETE';
                badge.className = 'badge bg-success';
            } else {
                badge.textContent = 'PENDING';
                badge.className = 'badge bg-warning';
            }
        }
        
        // =============== SCHOOL PROFILE FUNCTIONS ===============
        
        function loadSchoolProfileForm() {
            if (!schoolProfile) return;
            
            document.getElementById('schoolName').value = schoolProfile.schoolName || '';
            document.getElementById('circle').value = schoolProfile.circle || '';
            document.getElementById('villageWard').value = schoolProfile.villageWard || '';
            document.getElementById('policeStation').value = schoolProfile.policeStation || '';
            document.getElementById('postOffice').value = schoolProfile.postOffice || '';
            document.getElementById('gramPanchayat').value = schoolProfile.gramPanchayat || '';
            document.getElementById('pinCode').value = schoolProfile.pinCode || '';
            document.getElementById('diseCode').value = schoolProfile.diseCode || '';
            document.getElementById('schoolNumber').value = schoolProfile.schoolNumber || '';
        }
        
        async function saveSchoolProfile() {
            try {
                const profileData = {
                    mobile: currentUser,
                    schoolName: document.getElementById('schoolName').value,
                    circle: document.getElementById('circle').value,
                    villageWard: document.getElementById('villageWard').value,
                    policeStation: document.getElementById('policeStation').value,
                    postOffice: document.getElementById('postOffice').value,
                    gramPanchayat: document.getElementById('gramPanchayat').value,
                    pinCode: document.getElementById('pinCode').value,
                    diseCode: document.getElementById('diseCode').value,
                    schoolNumber: document.getElementById('schoolNumber').value
                };
                
                // Validate PIN
                if (!/^\d{6}$/.test(profileData.pinCode)) {
                    showMessage('PIN code must be 6 digits', 'error');
                    return;
                }
                
                const result = await callAPI('saveSchoolProfile', profileData);
                
                if (result.success) {
                    schoolProfile = profileData;
                    showMessage('School profile saved successfully!', 'success');
                    updateDashboard();
                    showView('dashboardView');
                } else {
                    showMessage(result.message || 'Failed to save profile', 'error');
                }
            } catch (error) {
                showMessage('Error saving profile: ' + error.message, 'error');
            }
        }
        
        // =============== TEACHER FUNCTIONS ===============
        
        function renderTeachersTable() {
            if (teachers.length === 0) {
                elements.noTeachersRow.style.display = '';
                return;
            }
            
            elements.noTeachersRow.style.display = 'none';
            elements.teachersTableBody.innerHTML = '';
            
            teachers.forEach((teacher, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${teacher.Name}</strong></td>
                    <td>${teacher.Designation}</td>
                    <td>${teacher.Qualification}</td>
                    <td>${formatDate(teacher.DOB)}</td>
                    <td>${formatDate(teacher['First Join'])}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTeacher(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTeacher(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                elements.teachersTableBody.appendChild(row);
            });
        }
        
        function showAddTeacherModal(editIndex = null) {
            const modal = new bootstrap.Modal(document.getElementById('teacherModal'));
            const form = document.getElementById('teacherForm');
            
            if (editIndex !== null && teachers[editIndex]) {
                // Edit mode
                document.getElementById('teacherModalTitle').textContent = 'Edit Teacher';
                document.getElementById('teacherEditId').value = editIndex;
                
                const teacher = teachers[editIndex];
                document.getElementById('teacherName').value = teacher.Name || '';
                document.getElementById('teacherDesignation').value = teacher.Designation || '';
                document.getElementById('teacherQualification').value = teacher.Qualification || '';
                document.getElementById('teacherTraining').value = teacher.Training || '';
                document.getElementById('teacherDOB').value = teacher.DOB || '';
                document.getElementById('teacherROPA').value = teacher['ROPA-19'] || '';
                document.getElementById('teacherRetirement').value = teacher.Retainment || '';
                document.getElementById('teacherFirstJoin').value = teacher['First Join'] || '';
                document.getElementById('teacherDistrictJoin').value = teacher['District Join'] || '';
                document.getElementById('teacherSchoolJoin').value = teacher['Present School Join'] || '';
            } else {
                // Add mode
                document.getElementById('teacherModalTitle').textContent = 'Add New Teacher';
                document.getElementById('teacherEditId').value = '';
                form.reset();
            }
            
            modal.show();
        }
        
        function editTeacher(index) {
            showAddTeacherModal(index);
        }
        
        async function deleteTeacher(index) {
            if (!confirm('Are you sure you want to delete this teacher?')) return;
            
            try {
                const teacher = teachers[index];
                const result = await callAPI('deleteTeacher', {
                    mobile: currentUser,
                    teacherId: teacher.teacher_id
                });
                
                if (result.success) {
                    teachers.splice(index, 1);
                    renderTeachersTable();
                    updateDashboard();
                    showMessage('Teacher deleted successfully', 'success');
                } else {
                    showMessage(result.message || 'Failed to delete teacher', 'error');
                }
            } catch (error) {
                showMessage('Error deleting teacher: ' + error.message, 'error');
            }
        }
        
        async function saveTeacher() {
            try {
                const teacherData = {
                    mobile: currentUser,
                    name: document.getElementById('teacherName').value,
                    designation: document.getElementById('teacherDesignation').value,
                    qualification: document.getElementById('teacherQualification').value,
                    training: document.getElementById('teacherTraining').value,
                    dob: document.getElementById('teacherDOB').value,
                    ropa: document.getElementById('teacherROPA').value,
                    retirement: document.getElementById('teacherRetirement').value,
                    firstJoin: document.getElementById('teacherFirstJoin').value,
                    districtJoin: document.getElementById('teacherDistrictJoin').value,
                    schoolJoin: document.getElementById('teacherSchoolJoin').value
                };
                
                // Validate required fields
                if (!teacherData.name || !teacherData.designation || !teacherData.qualification || 
                    !teacherData.dob || !teacherData.firstJoin) {
                    showMessage('Please fill all required fields', 'error');
                    return;
                }
                
                const editIndex = document.getElementById('teacherEditId').value;
                let result;
                
                if (editIndex !== '') {
                    // Update existing teacher
                    teacherData.teacher_id = teachers[editIndex].teacher_id;
                    result = await callAPI('updateTeacher', teacherData);
                    
                    if (result.success) {
                        teachers[editIndex] = { ...teachers[editIndex], ...teacherData };
                        showMessage('Teacher updated successfully', 'success');
                    }
                } else {
                    // Add new teacher
                    result = await callAPI('addTeacher', teacherData);
                    
                    if (result.success) {
                        teacherData.teacher_id = result.teacher_id;
                        teachers.push(teacherData);
                        showMessage('Teacher added successfully', 'success');
                    }
                }
                
                if (result.success) {
                    renderTeachersTable();
                    updateDashboard();
                    bootstrap.Modal.getInstance(document.getElementById('teacherModal')).hide();
                } else {
                    showMessage(result.message || 'Failed to save teacher', 'error');
                }
                
            } catch (error) {
                showMessage('Error saving teacher: ' + error.message, 'error');
            }
        }
        
        // =============== CLASSES FUNCTIONS ===============
        
        function loadClassesForm() {
            const classes = ['Pre-Primary', 'Class I', 'Class II', 'Class III', 'Class IV', 'Class V'];
            
            classes.forEach(className => {
                const checkbox = document.getElementById(`class${className.replace(' ', '')}`);
                if (checkbox) {
                    checkbox.checked = selectedClasses.includes(className);
                }
            });
        }
        
        async function saveClasses() {
            try {
                const classes = ['Pre-Primary', 'Class I', 'Class II', 'Class III', 'Class IV', 'Class V'];
                const selected = [];
                
                classes.forEach(className => {
                    const checkbox = document.getElementById(`class${className.replace(' ', '')}`);
                    if (checkbox && checkbox.checked) {
                        selected.push(className);
                    }
                });
                
                if (selected.length === 0) {
                    showMessage('Please select at least one class', 'error');
                    return;
                }
                
                const result = await callAPI('saveSelectedClasses', {
                    mobile: currentUser,
                    classes: selected
                });
                
                if (result.success) {
                    selectedClasses = selected;
                    showMessage('Classes saved successfully', 'success');
                    updateDashboard();
                    showView('dashboardView');
                } else {
                    showMessage(result.message || 'Failed to save classes', 'error');
                }
            } catch (error) {
                showMessage('Error saving classes: ' + error.message, 'error');
            }
        }
        
        // =============== MONTHLY RETURN FUNCTIONS ===============
        
        function initializeMonthSelection() {
            // Populate years (current year and 5 previous years)
            const currentYear = new Date().getFullYear();
            elements.selectYear.innerHTML = '';
            
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                elements.selectYear.appendChild(option);
            }
            
            // Set current month (previous month)
            const currentMonth = new Date().getMonth(); // 0-11
            const previousMonth = currentMonth === 0 ? 12 : currentMonth; // Handle January
            document.getElementById('selectMonth').value = previousMonth;
            
            // Set current year
            elements.selectYear.value = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            // Load teacher leaves table
            loadTeacherLeavesTable();
            
            // Load student data form
            loadStudentDataForm();
        }
        
        function loadTeacherLeavesTable() {
            if (teachers.length === 0) {
                elements.noTeachersForLeave.style.display = 'block';
                elements.teacherLeavesContainer.innerHTML = '';
                return;
            }
            
            elements.noTeachersForLeave.style.display = 'none';
            
            const tableHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th rowspan="2">Teacher Name</th>
                                <th colspan="5" class="text-center bengali">Leave Types (ছুটির প্রকার)</th>
                                <th rowspan="2">Total Leaves</th>
                                <th rowspan="2">Present Days</th>
                            </tr>
                            <tr class="bengali">
                                <th class="text-center">°ej¢šL<br><small>(Casual)</small></th>
                                <th class="text-center">¢h¢eju<br><small>(Commuted)</small></th>
                                <th class="text-center">AdÑ­hae<br><small>(Half Pay)</small></th>
                                <th class="text-center">j¡a«aÆ<br><small>(Maternity)</small></th>
                                <th class="text-center">¢he¡­h­ae<br><small>(Without Pay)</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teachers.map((teacher, index) => `
                                <tr>
                                    <td><strong>${teacher.Name}</strong><br><small>${teacher.Designation}</small></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm leave-input" 
                                           data-teacher-index="${index}" data-leave-type="casual" value="0"></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm leave-input" 
                                           data-teacher-index="${index}" data-leave-type="commuted" value="0"></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm leave-input" 
                                           data-teacher-index="${index}" data-leave-type="halfpay" value="0"></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm leave-input" 
                                           data-teacher-index="${index}" data-leave-type="maternity" value="0"></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm leave-input" 
                                           data-teacher-index="${index}" data-leave-type="withoutpay" value="0"></td>
                                    <td class="text-center"><span id="total-leaves-${index}">0</span></td>
                                    <td class="text-center"><span id="present-days-${index}">0</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-calculator"></i> 
                    Totals and present days are calculated automatically based on working days.
                </div>
            `;
            
            elements.teacherLeavesContainer.innerHTML = tableHTML;
            
            // Add event listeners to leave inputs
            document.querySelectorAll('.leave-input').forEach(input => {
                input.addEventListener('input', calculateLeaveTotals);
            });
            
            // Initial calculation
            calculateLeaveTotals();
        }
        
        function calculateLeaveTotals() {
            const workingDays = parseInt(elements.totalWorkingDays.value) || 0;
            
            teachers.forEach((teacher, index) => {
                let totalLeaves = 0;
                
                // Sum all leave types
                ['casual', 'commuted', 'halfpay', 'maternity', 'withoutpay'].forEach(type => {
                    const input = document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="${type}"]`);
                    if (input) {
                        totalLeaves += parseInt(input.value) || 0;
                    }
                });
                
                // Update totals
                document.getElementById(`total-leaves-${index}`).textContent = totalLeaves;
                document.getElementById(`present-days-${index}`).textContent = Math.max(0, workingDays - totalLeaves);
            });
        }
        
        function loadStudentDataForm() {
            if (selectedClasses.length === 0) {
                elements.noClassesForStudent.style.display = 'block';
                elements.studentDataContainer.innerHTML = '';
                return;
            }
            
            elements.noClassesForStudent.style.display = 'none';
            
            const formHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-info">
                            <tr>
                                <th>Class</th>
                                <th>Boys</th>
                                <th>Girls</th>
                                <th>Total</th>
                                <th>Remarks (Optional)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedClasses.map(className => `
                                <tr>
                                    <td><strong>${className}</strong></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm student-boys" 
                                           data-class="${className}" value="0"></td>
                                    <td><input type="number" min="0" class="form-control form-control-sm student-girls" 
                                           data-class="${className}" value="0"></td>
                                    <td class="text-center"><span id="total-${className.replace(' ', '-')}">0</span></td>
                                    <td><input type="text" class="form-control form-control-sm" 
                                           data-class="${className}" placeholder="Optional"></td>
                                </tr>
                            `).join('')}
                            <tr class="table-secondary">
                                <td><strong>Grand Total</strong></td>
                                <td class="text-center"><span id="grand-total-boys">0</span></td>
                                <td class="text-center"><span id="grand-total-girls">0</span></td>
                                <td class="text-center"><span id="grand-total-students">0</span></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            elements.studentDataContainer.innerHTML = formHTML;
            
            // Add event listeners
            document.querySelectorAll('.student-boys, .student-girls').forEach(input => {
                input.addEventListener('input', calculateStudentTotals);
            });
            
            // Initial calculation
            calculateStudentTotals();
        }
        
        function calculateStudentTotals() {
            let totalBoys = 0;
            let totalGirls = 0;
            let totalStudents = 0;
            
            selectedClasses.forEach(className => {
                const boysInput = document.querySelector(`.student-boys[data-class="${className}"]`);
                const girlsInput = document.querySelector(`.student-girls[data-class="${className}"]`);
                
                const boys = parseInt(boysInput?.value) || 0;
                const girls = parseInt(girlsInput?.value) || 0;
                const classTotal = boys + girls;
                
                totalBoys += boys;
                totalGirls += girls;
                totalStudents += classTotal;
                
                // Update class total
                const totalElement = document.getElementById(`total-${className.replace(' ', '-')}`);
                if (totalElement) {
                    totalElement.textContent = classTotal;
                }
            });
            
            // Update grand totals
            document.getElementById('grand-total-boys').textContent = totalBoys;
            document.getElementById('grand-total-girls').textContent = totalGirls;
            document.getElementById('grand-total-students').textContent = totalStudents;
        }
        
        async function generateMonthlyReturn() {
            try {
                // Validate working days
                const workingDays = parseInt(elements.totalWorkingDays.value);
                if (!workingDays || workingDays < 1 || workingDays > 31) {
                    showMessage('Please enter valid working days (1-31)', 'error');
                    return;
                }
                
                // Collect teacher leaves data
                const teacherLeaves = [];
                teachers.forEach((teacher, index) => {
                    const leaves = {
                        teacher_id: teacher.teacher_id,
                        teacher_name: teacher.Name,
                        casual: parseInt(document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="casual"]`).value) || 0,
                        commuted: parseInt(document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="commuted"]`).value) || 0,
                        halfpay: parseInt(document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="halfpay"]`).value) || 0,
                        maternity: parseInt(document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="maternity"]`).value) || 0,
                        withoutpay: parseInt(document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="withoutpay"]`).value) || 0
                    };
                    leaves.total = leaves.casual + leaves.commuted + leaves.halfpay + leaves.maternity + leaves.withoutpay;
                    leaves.present = Math.max(0, workingDays - leaves.total);
                    teacherLeaves.push(leaves);
                });
                
                // Collect student data
                const studentData = [];
                selectedClasses.forEach(className => {
                    const data = {
                        class: className,
                        boys: parseInt(document.querySelector(`.student-boys[data-class="${className}"]`).value) || 0,
                        girls: parseInt(document.querySelector(`.student-girls[data-class="${className}"]`).value) || 0,
                        remarks: document.querySelector(`input[data-class="${className}"]:last-of-type`).value || ''
                    };
                    studentData.push(data);
                });
                
                // Prepare month data
                const monthData = {
                    mobile: currentUser,
                    month: parseInt(document.getElementById('selectMonth').value),
                    year: parseInt(elements.selectYear.value),
                    workingDays: workingDays,
                    teacherLeaves: teacherLeaves,
                    studentData: studentData
                };
                
                // Validate month is not in future
                const currentDate = new Date();
                const selectedDate = new Date(monthData.year, monthData.month - 1);
                if (selectedDate > currentDate) {
                    showMessage('Cannot create returns for future months', 'error');
                    return;
                }
                
                // Save to database
                const result = await callAPI('saveMonthlyReturn', monthData);
                
                if (result.success) {
                    showMessage('Monthly return data saved successfully!', 'success');
                    
                    // Generate and download PDF
                    await generatePDF(monthData);
                    
                    // Show success message
                    showMessage('PDF generated and downloaded successfully!', 'success');
                    
                    // Redirect to previous returns
                    setTimeout(() => showView('previousReturnsView'), 2000);
                } else {
                    showMessage(result.message || 'Failed to save monthly return', 'error');
                }
                
            } catch (error) {
                showMessage('Error generating return: ' + error.message, 'error');
            }
        }
        
        // =============== PDF GENERATION ===============
        
        async function generatePDF(monthData) {
            showLoading('Generating PDF...');
            
            try {
                // Calculate number of pages needed (7 teachers per page)
                const teachersPerPage = 7;
                const totalPages = Math.ceil(teachers.length / teachersPerPage);
                
                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Month name
                const monthNames = ["January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
                const monthName = monthNames[monthData.month - 1];
                
                // Generate each page
                for (let page = 0; page < totalPages; page++) {
                    if (page > 0) {
                        pdf.addPage();
                    }
                    
                    // Add header (same on every page)
                    addHeader(pdf, monthData, monthName, page + 1, totalPages);
                    
                    // Add school info (same on every page)
                    addSchoolInfo(pdf, monthData, monthName);
                    
                    // Add teacher table for this page
                    const startIdx = page * teachersPerPage;
                    const endIdx = Math.min(startIdx + teachersPerPage, teachers.length);
                    const pageTeachers = teachers.slice(startIdx, endIdx);
                    const pageTeacherLeaves = monthData.teacherLeaves.slice(startIdx, endIdx);
                    
                    addTeacherTable(pdf, pageTeachers, pageTeacherLeaves, monthData.workingDays, startIdx);
                    
                    // Add student data (only on last page)
                    if (page === totalPages - 1) {
                        addStudentData(pdf, monthData.studentData);
                        
                        // Add signature section
                        addSignatures(pdf);
                    }
                }
                
                // Download PDF
                const fileName = `Monthly_Return_${schoolProfile.schoolNumber}_${monthName}_${monthData.year}.pdf`;
                pdf.save(fileName);
                
                // Save to database
                await callAPI('saveGeneratedPDF', {
                    mobile: currentUser,
                    month: monthData.month,
                    year: monthData.year,
                    filename: fileName,
                    pages: totalPages
                });
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showMessage('Error generating PDF: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function addHeader(pdf, monthData, monthName, page, totalPages) {
            // Header styling
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(0, 0, 0);
            
            // Title
            pdf.text('MONTHLY RETURN OF PRIMARY SCHOOL', 105, 15, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('(As per RTE Act 2009)', 105, 20, { align: 'center' });
            
            // Page number
            pdf.setFontSize(8);
            pdf.text(`Page ${page} of ${totalPages}`, 190, 10, { align: 'right' });
            
            // Line separator
            pdf.setLineWidth(0.5);
            pdf.line(10, 25, 200, 25);
        }
        
        function addSchoolInfo(pdf, monthData, monthName) {
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            // School info box (yellow background simulation)
            pdf.setFillColor(255, 250, 205);
            pdf.rect(10, 30, 190, 40, 'F');
            
            pdf.setFont('helvetica', 'bold');
            pdf.text('SCHOOL INFORMATION', 105, 35, { align: 'center' });
            
            pdf.setFont('helvetica', 'normal');
            let yPos = 42;
            
            // School details
            const details = [
                { label: 'School Name:', value: schoolProfile.schoolName },
                { label: 'Circle:', value: schoolProfile.circle },
                { label: 'Village/Ward:', value: schoolProfile.villageWard },
                { label: 'P.S.:', value: schoolProfile.policeStation },
                { label: 'Post Office:', value: schoolProfile.postOffice },
                { label: 'Gram Panchayat/Municipality:', value: schoolProfile.gramPanchayat },
                { label: 'PIN:', value: schoolProfile.pinCode },
                { label: 'DISE Code:', value: schoolProfile.diseCode },
                { label: 'School No.:', value: schoolProfile.schoolNumber },
                { label: 'Month:', value: `${monthName} ${monthData.year}` }
            ];
            
            // Two columns
            details.forEach((detail, index) => {
                const xPos = index % 2 === 0 ? 15 : 110;
                const row = Math.floor(index / 2);
                
                pdf.setFont('helvetica', 'bold');
                pdf.text(detail.label, xPos, yPos + (row * 5));
                
                pdf.setFont('helvetica', 'normal');
                pdf.text(detail.value || '', xPos + 40, yPos + (row * 5));
            });
        }
        
        function addTeacherTable(pdf, pageTeachers, pageTeacherLeaves, workingDays, startIdx) {
            const startY = 75;
            
            // Table header
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(9);
            
            const headers = ['SL', 'Teacher Name', 'Designation', 'Qualification', 'DOB', 'Salary', 'Retirement', 'First Join', 'Present Join'];
            const colWidths = [8, 35, 20, 25, 20, 20, 20, 20, 22];
            
            let xPos = 10;
            headers.forEach((header, index) => {
                pdf.text(header, xPos + colWidths[index]/2, startY, { align: 'center' });
                xPos += colWidths[index];
            });
            
            // Draw table lines
            pdf.setLineWidth(0.1);
            pdf.line(10, startY + 2, 200, startY + 2);
            
            // Teacher rows
            let currentY = startY + 8;
            
            pageTeachers.forEach((teacher, index) => {
                const globalIndex = startIdx + index;
                const leaves = pageTeacherLeaves[index];
                
                // Alternate row color
                if (index % 2 === 0) {
                    pdf.setFillColor(240, 240, 240);
                    pdf.rect(10, currentY - 3, 190, 8, 'F');
                }
                
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                
                xPos = 10;
                const rowData = [
                    (globalIndex + 1).toString(),
                    teacher.Name,
                    teacher.Designation,
                    teacher.Qualification,
                    formatDate(teacher.DOB, 'dd/mm/yyyy'),
                    teacher['ROPA-19'] || '0',
                    formatDate(teacher.Retainment, 'dd/mm/yyyy'),
                    formatDate(teacher['First Join'], 'dd/mm/yyyy'),
                    formatDate(teacher['Present School Join'], 'dd/mm/yyyy') || '-'
                ];
                
                rowData.forEach((data, colIndex) => {
                    // Truncate long text
                    const text = data || '';
                    const maxWidth = colWidths[colIndex] - 2;
                    
                    pdf.text(text.substring(0, 15), xPos + 1, currentY, { maxWidth });
                    xPos += colWidths[colIndex];
                });
                
                currentY += 8;
            });
            
            // Leave section header
            currentY += 5;
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(9);
            pdf.text('LEAVE DETAILS FOR THE MONTH', 105, currentY, { align: 'center' });
            currentY += 5;
            
            // Leave table headers
            const leaveHeaders = ['Teacher', 'Casual', 'Commuted', 'Half Pay', 'Maternity', 'Without Pay', 'Total Leaves', 'Present Days'];
            const leaveWidths = [35, 15, 15, 15, 15, 15, 15, 15];
            
            xPos = 10;
            leaveHeaders.forEach((header, index) => {
                pdf.text(header, xPos + leaveWidths[index]/2, currentY, { align: 'center' });
                xPos += leaveWidths[index];
            });
            
            currentY += 5;
            
            // Leave data rows
            pageTeacherLeaves.forEach((leaves, index) => {
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                
                xPos = 10;
                const leaveData = [
                    pageTeachers[index].Name.substring(0, 15),
                    leaves.casual.toString(),
                    leaves.commuted.toString(),
                    leaves.halfpay.toString(),
                    leaves.maternity.toString(),
                    leaves.withoutpay.toString(),
                    leaves.total.toString(),
                    leaves.present.toString()
                ];
                
                leaveData.forEach((data, colIndex) => {
                    pdf.text(data, xPos + 1, currentY, { maxWidth: leaveWidths[colIndex] - 2 });
                    xPos += leaveWidths[colIndex];
                });
                
                currentY += 5;
            });
        }
        
        function addStudentData(pdf, studentData) {
            let currentY = pdf.internal.pageSize.height - 100;
            
            // Student data header
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.text('STUDENT DETAILS', 105, currentY, { align: 'center' });
            currentY += 7;
            
            // Table headers
            const headers = ['Class', 'Boys', 'Girls', 'Total', 'Remarks'];
            const widths = [30, 20, 20, 20, 100];
            
            let xPos = 10;
            headers.forEach((header, index) => {
                pdf.text(header, xPos + widths[index]/2, currentY, { align: 'center' });
                xPos += widths[index];
            });
            
            currentY += 5;
            
            // Student data rows
            let totalBoys = 0;
            let totalGirls = 0;
            let totalStudents = 0;
            
            studentData.forEach(data => {
                const classTotal = data.boys + data.girls;
                totalBoys += data.boys;
                totalGirls += data.girls;
                totalStudents += classTotal;
                
                xPos = 10;
                const rowData = [
                    data.class,
                    data.boys.toString(),
                    data.girls.toString(),
                    classTotal.toString(),
                    data.remarks || ''
                ];
                
                rowData.forEach((cellData, index) => {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(cellData, xPos + 2, currentY, { maxWidth: widths[index] - 4 });
                    xPos += widths[index];
                });
                
                currentY += 6;
            });
            
            // Totals row
            currentY += 2;
            pdf.setFont('helvetica', 'bold');
            pdf.setFillColor(220, 220, 220);
            pdf.rect(10, currentY - 3, 190, 6, 'F');
            
            xPos = 10;
            const totals = ['GRAND TOTAL', totalBoys.toString(), totalGirls.toString(), totalStudents.toString(), ''];
            
            totals.forEach((total, index) => {
                pdf.text(total, xPos + widths[index]/2, currentY, { align: 'center' });
                xPos += widths[index];
            });
        }
        
        function addSignatures(pdf) {
            const yPos = pdf.internal.pageSize.height - 30;
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            
            // Left signature
            pdf.line(30, yPos, 80, yPos);
            pdf.text('Signature of Head Teacher', 55, yPos + 5, { align: 'center' });
            
            // Right signature
            pdf.line(130, yPos, 180, yPos);
            pdf.text('Signature of SMC President', 155, yPos + 5, { align: 'center' });
            
            // Date
            pdf.text(`Date: ${new Date().toLocaleDateString('en-GB')}`, 105, yPos + 15, { align: 'center' });
        }
        
        function formatDate(dateString, format = 'dd/mm/yyyy') {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                
                if (format === 'dd/mm/yyyy') {
                    return `${day}/${month}/${year}`;
                }
                return dateString;
            } catch (error) {
                return dateString;
            }
        }
        
        // =============== PREVIOUS RETURNS ===============
        
        async function loadPreviousReturns() {
            try {
                const result = await callAPI('getPreviousReturns', { mobile: currentUser });
                
                if (result.success && result.returns && result.returns.length > 0) {
                    renderPreviousReturnsTable(result.returns);
                } else {
                    document.getElementById('noReturnsRow').style.display = '';
                }
            } catch (error) {
                console.error('Error loading previous returns:', error);
            }
        }
        
        function renderPreviousReturnsTable(returns) {
            const tbody = document.getElementById('previousReturnsTableBody');
            tbody.innerHTML = '';
            
            document.getElementById('noReturnsRow').style.display = 'none';
            
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            
            returns.forEach(ret => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${monthNames[ret.month - 1]} ${ret.year}</strong></td>
                    <td>${formatDate(ret.generation_date, 'dd/mm/yyyy')}</td>
                    <td>${ret.working_days}</td>
                    <td>${ret.teacher_count}</td>
                    <td>${ret.pages}</td>
                    <td>
                        <span class="badge ${ret.status === 'corrected' ? 'bg-warning' : 'bg-success'}">
                            ${ret.status || 'original'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="downloadReturn('${ret.return_id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editReturn('${ret.return_id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function downloadReturn(returnId) {
            try {
                showLoading('Preparing download...');
                const result = await callAPI('downloadReturn', { returnId });
                
                if (result.success && result.pdfData) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = result.pdfData;
                    link.download = result.filename || `Monthly_Return_${returnId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showMessage('PDF download started', 'success');
                } else {
                    showMessage(result.message || 'Failed to download PDF', 'error');
                }
            } catch (error) {
                showMessage('Download error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function editReturn(returnId) {
            document.getElementById('editReturnId').value = returnId;
            const modal = new bootstrap.Modal(document.getElementById('editReturnModal'));
            modal.show();
        }
        
        async function confirmEditReturn() {
            const returnId = document.getElementById('editReturnId').value;
            const note = document.getElementById('editCorrectionNote').value;
            
            if (!note.trim()) {
                showMessage('Please enter a correction note', 'error');
                return;
            }
            
            try {
                // Load the return data for editing
                const result = await callAPI('loadReturnForEdit', { returnId });
                
                if (result.success) {
                    // Populate the make return view with this data
                    currentMonthData = result.data;
                    loadReturnForEditing(result.data);
                    
                    // Close modal and switch to make return view
                    bootstrap.Modal.getInstance(document.getElementById('editReturnModal')).hide();
                    showView('makeReturnView');
                    
                    showMessage('Now editing return with correction note', 'info');
                } else {
                    showMessage(result.message || 'Failed to load return for editing', 'error');
                }
            } catch (error) {
                showMessage('Error loading return: ' + error.message, 'error');
            }
        }
        
        function loadReturnForEditing(returnData) {
            // Set month and year
            document.getElementById('selectMonth').value = returnData.month;
            elements.selectYear.value = returnData.year;
            elements.totalWorkingDays.value = returnData.workingDays;
            
            // Populate teacher leaves
            if (returnData.teacherLeaves) {
                returnData.teacherLeaves.forEach((leaves, index) => {
                    if (index < teachers.length) {
                        document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="casual"]`).value = leaves.casual || 0;
                        document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="commuted"]`).value = leaves.commuted || 0;
                        document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="halfpay"]`).value = leaves.halfpay || 0;
                        document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="maternity"]`).value = leaves.maternity || 0;
                        document.querySelector(`.leave-input[data-teacher-index="${index}"][data-leave-type="withoutpay"]`).value = leaves.withoutpay || 0;
                    }
                });
                calculateLeaveTotals();
            }
            
            // Populate student data
            if (returnData.studentData) {
                returnData.studentData.forEach(data => {
                    const boysInput = document.querySelector(`.student-boys[data-class="${data.class}"]`);
                    const girlsInput = document.querySelector(`.student-girls[data-class="${data.class}"]`);
                    const remarksInput = document.querySelector(`input[data-class="${data.class}"]:last-of-type`);
                    
                    if (boysInput) boysInput.value = data.boys || 0;
                    if (girlsInput) girlsInput.value = data.girls || 0;
                    if (remarksInput) remarksInput.value = data.remarks || '';
                });
                calculateStudentTotals();
            }
            
            // Store correction note
            currentMonthData.correctionNote = document.getElementById('editCorrectionNote').value;
        }
        
        // =============== ADMIN FUNCTIONS ===============
        
        async function loadAdminData() {
            try {
                const result = await callAPI('getAllSchools');
                
                if (result.success && result.schools) {
                    renderAdminTable(result.schools);
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        function renderAdminTable(schools) {
            const tbody = document.getElementById('adminSchoolsTableBody');
            tbody.innerHTML = '';
            
            schools.forEach(school => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.schoolName || 'Not set'}</td>
                    <td>${school.mobile}</td>
                    <td>${school.circle || '-'}</td>
                    <td>${school.villageWard || '-'}</td>
                    <td>${school.teacherCount || 0}</td>
                    <td>${school.lastReturn || 'Never'}</td>
                    <td>
                        <span class="badge ${school.profile_done ? 'bg-success' : 'bg-warning'}">
                            ${school.profile_done ? 'Active' : 'Incomplete'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewSchoolDetails('${school.mobile}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function viewSchoolDetails(mobile) {
            try {
                const result = await callAPI('getSchoolDetails', { mobile });
                
                if (result.success) {
                    const content = document.getElementById('schoolDetailsContent');
                    content.innerHTML = `
                        <h5>${result.school.schoolName || 'No Name'}</h5>
                        <hr>
                        <p><strong>Mobile:</strong> ${result.school.mobile}</p>
                        <p><strong>Email:</strong> ${result.school.email}</p>
                        <p><strong>Circle:</strong> ${result.school.circle || '-'}</p>
                        <p><strong>Village/Ward:</strong> ${result.school.villageWard || '-'</p>
                        <p><strong>Police Station:</strong> ${result.school.policeStation || '-'}</p>
                        <p><strong>Post Office:</strong> ${result.school.postOffice || '-'}</p>
                        <p><strong>Gram Panchayat:</strong> ${result.school.gramPanchayat || '-'}</p>
                        <p><strong>PIN:</strong> ${result.school.pinCode || '-'}</p>
                        <p><strong>DISE Code:</strong> ${result.school.diseCode || '-'}</p>
                        <p><strong>School Number:</strong> ${result.school.schoolNumber || '-'}</p>
                        <hr>
                        <p><strong>Teachers:</strong> ${result.teachers?.length || 0}</p>
                        <p><strong>Last Return:</strong> ${result.lastReturn || 'Never'}</p>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('viewSchoolModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading school details:', error);
            }
        }
        
        // =============== EVENT LISTENERS ===============
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Monthly Return Maker v' + APP_VERSION + ' loaded');
            
            // Login form
            document.getElementById('loginFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                const mobile = elements.loginMobile.value;
                const password = elements.loginPassword.value;
                login(mobile, password);
            });
            
            // Registration form
            document.getElementById('registerFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                const mobile = elements.regMobile.value;
                const password = elements.regPassword.value;
                const email = elements.regEmail.value;
                register(mobile, password, email);
            });
            
            // Forgot password form
            document.getElementById('forgotFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                const mobile = elements.forgotMobile.value;
                const email = elements.forgotEmail.value;
                forgotPassword(mobile, email);
            });
            
            // School profile form
            document.getElementById('schoolProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSchoolProfile();
            });
            
            // Classes form
            document.getElementById('classesForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveClasses();
            });
            
            // Make return view initialization
            document.getElementById('makeReturnBtn').addEventListener('click', function() {
                if (this.disabled) {
                    showMessage('Please complete all 3 tasks first', 'warning');
                    return;
                }
                initializeMonthSelection();
                showView('makeReturnView');
            });
            
            // Quick make return button
            elements.quickMakeReturnBtn.addEventListener('click', function() {
                if (this.disabled) {
                    showMessage('Please complete all 3 tasks first', 'warning');
                    return;
                }
                initializeMonthSelection();
                showView('makeReturnView');
            });
            
            // Generate PDF button
            elements.generatePdfBtn.addEventListener('click', function() {
                generateMonthlyReturn();
            });
            
            // Working days input updates leave calculations
            elements.totalWorkingDays.addEventListener('input', calculateLeaveTotals);
            
            // Password toggle buttons
            document.getElementById('toggleLoginPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('loginPassword');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
            
            document.getElementById('toggleRegPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('regPassword');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
            
            // Auto-populate username from mobile in registration
            elements.regMobile.addEventListener('input', function() {
                // Auto-suggest as username
                if (this.value.length === 10) {
                    showMessage('This mobile number will be your username', 'info');
                }
            });
        });
    </script>
</body>
</html>
